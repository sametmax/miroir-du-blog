<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Sam &#38; Max &#187; linux</title>
	<atom:link href="http://sametmax.com/tag/linux/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Sat, 07 Nov 2015 10:56:13 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=4.1</generator>
	<item>
		<title>Désactiver un service dans Ubuntu 14.04 11</title>
		<link>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/</link>
		<comments>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/#comments</comments>
		<pubDate>Tue, 25 Aug 2015 11:25:59 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[daemon]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[service]]></category>
		<category><![CDATA[ubuntu]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16801</guid>
		<description><![CDATA[Quand on installe un service, Ubuntu le lance automatiquement, et installe de quoi le faire démarer à chaque boot de la machine. Si c&#8217;est votre machine de dev, vous ne voulez peut être pas qu&#8217;Apache, Nginx, Redis, MySQL, ElasticSearch, Solr, Supervisor, Postgres, Docker, et MongoDB soient up à chaque fois tous en même temps alors [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Quand on installe un service, Ubuntu le lance automatiquement, et installe de quoi le faire démarer à chaque boot de la machine.</p>
<p>Si c&#8217;est votre machine de dev, vous ne voulez peut être pas qu&#8217;Apache, Nginx, Redis, MySQL, ElasticSearch, Solr, Supervisor, Postgres, Docker, et MongoDB soient up à chaque fois tous en même temps alors que vous voulez juste vous palucher sur youjizz.</p>
<p>La plupart des scripts de démarrage sont dans /etc/initd.d:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d
acpid           brltty             grub-common  lpd         pppd-dns      resolvconf   skeleton           unattended-upgrades
anacron         console-setup      halt...</pre></td></tr></table></div>

<p>Mais ces scripts sont lancés parce qu&#8217;ils sont symlinkés dans un des répertoires <code>/etc/rcX</code>:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc<span style="color: #000000; font-weight: bold;">*</span>.d<span style="color: #000000; font-weight: bold;">/*</span>apache<span style="color: #000000; font-weight: bold;">*</span>
<span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc0.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2  <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc5.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2  <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc6.d<span style="color: #000000; font-weight: bold;">/</span>K80apache2</pre></td></tr></table></div>

<p>Ouai, j&#8217;ai encore des clients qui utilisent apache. Certains utilisent même Tomcat.</p>
<p>Pour désactiver le démarrage automatique, vous pouvez essayer bourinement la suppression des liens :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">rm</span> $<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>rc<span style="color: #000000; font-weight: bold;">*</span>.d<span style="color: #000000; font-weight: bold;">/*</span>apache<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>Ça marche. </p>
<p>Solution plus pratique, utiliser la commande <code>update-rc.d</code>, qui n&#8217;est pas faite pour l&#8217;utilisation par les humains, mais fuck it :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d <span style="color: #660033;">-f</span> apache2 remove</pre></td></tr></table></div>

<p>Ça supprime aussi tous les liens. <code>sudo update-rc.d -f apache2 disable</code> devrait le faire moins bourinement mais ne marche pas sur ma machine.</p>
<p>Pour inverser la tendance :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d apache2 defaults</pre></td></tr></table></div>

<p>(ou enable si par miracle ça marche pour vous)</p>
<p>Enfin, si le cœur vous en dit:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> update-rc.d <span style="color: #660033;">-f</span> apache2 remove
<span style="color: #c20cb9; font-weight: bold;">sudo</span> sysv-rc-conf</pre></td></tr></table></div>

<p>Vous donnera une joli interface curse pour le faire plus visuellement.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/desactiver-un-service-dans-ubuntu-14-04/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/08/JkC3vWe.gif" length="963671" type="image/jpg" />	</item>
		<item>
		<title>Le don du mois 8</title>
		<link>http://sametmax.com/le-don-du-mois/</link>
		<comments>http://sametmax.com/le-don-du-mois/#comments</comments>
		<pubDate>Mon, 08 Jun 2015 18:01:27 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[debian]]></category>
		<category><![CDATA[don]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[ubuntu]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=16360</guid>
		<description><![CDATA[Avec <a href="http://linuxfr.org/users/elessar/journaux/debian-adopte-systemd-comme-init-par-defaut">l'adoption de systemd par défaut</a>, ils vont avoir besoin de ressources pour réaménager la caverne à trolls.]]></description>
				<content:encoded><![CDATA[<p>J&#8217;utilise Ubuntu au quotidien, et j&#8217;ai déjà donné au projet, mais les dernières décisions prises par l&#8217;équipe de la distrib ne me paraissent pas toujours judicieuses.</p>
<p>Aussi, afin de contribuer à Ubuntu, mais aussi à de nombreux autres projets, le don du mois sera pour le projet <a href="https://www.debian.org/">Debian</a>, qui est à la racine de nombreuses distribs, dont Ubuntu. Les bénéfices se feront donc en cascade.</p>
<p>L&#8217;équipe de Debian a su garder un cap en terme de qualité et de stabilité au cours des longues années de son existence, et sur un projet libre de cette taille, c&#8217;est un exploit. </p>
<p><a href="https://www.debian.org/donations.fr.html">$50 partent donc pour eux.</a> Avec <a href="http://linuxfr.org/users/elessar/journaux/debian-adopte-systemd-comme-init-par-defaut">l&#8217;adoption de systemd par défaut</a>, ils vont avoir besoin de ressources pour réaménager la caverne à trolls.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/le-don-du-mois/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/06/Cad06H3.jpg" length="64307" type="image/jpg" />	</item>
		<item>
		<title>Écouter sur le port 80 sans être root 16</title>
		<link>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/</link>
		<comments>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/#comments</comments>
		<pubDate>Wed, 28 Jan 2015 13:47:08 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[port]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[reseau]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=15817</guid>
		<description><![CDATA[Sous beaucoup d'OS, tous les ports d'un nombre inférieur à 1024 ne peuvent pas être utilisés par des serveurs sans avoir les privilèges administrateurs. Néanmoins, on a pas vraiment envie que son app bricolée un lendemain de cuite soit lancée en root, pour que la moindre faille de sécurité donne l'accès total à son système.]]></description>
				<content:encoded><![CDATA[<p>Sous beaucoup d&#8217;OS, tous les ports d&#8217;un nombre inférieur à 1024 ne peuvent pas être utilisés par des processus sans avoir les privilèges administrateurs. Néanmoins, on a pas vraiment envie que son app bricolée un lendemain de cuite soit lancée en root, pour que la moindre faille de sécurité donne l&#8217;accès total à son système.</p>
<p>Beaucoup de logiciels se lancent en root, et relâchent leurs privilèges a posteriori. C&#8217;est ce que faisait Apache a une époque (peut être le fait-il toujours, j&#8217;ai pas cheché). Nginx lui, lance un processus racine en root, et spawn des enfants avec un utilisateur normal. </p>
<p>Mais nous, on a pas la foi de se faire chier à faire ça, donc généralement, on met nginx en front et il gère ça pour nous. </p>
<p>Sauf que, parfois, on a pas envie de mettre 40 couches devant notre app. Par exemple, si on utilise crossbar.io (ouai, j&#8217;ai encore réussi à le placer \o/), le logiciel est clairement capable d&#8217;être en front tout seul. </p>
<p>Bonne nouvelle, sur les Linux modernes, les exécutables peuvent avoir des <a href="http://linux.die.net/man/7/capabilities">permissions</a> avancées, comme &#8220;pourvoir changer l&#8217;horloge système&#8221; ou &#8220;empêcher la mise en veille&#8221;. Ces permissions sont changeables avec l&#8217;outil <code>setcap</code>.</p>
<p>Sous Ubuntu, ça s&#8217;installe avec :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> libcap2-bin</pre></td></tr></table></div>

<p>Puis on choisit l&#8217;exécutable à qui on veut donner nos nouvelles permissions. Dans mon cas, le Python du virtualenv de mon projet :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ pew workon super_projet
$ which python
/home/sam/.<span style="color: black;">local</span>/share/virtualenvs/super_projet/bin/python</pre></td></tr></table></div>

<p>Je check si il a pas déjà des permissions (normalement non) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ sudo getcap `which python`</pre></td></tr></table></div>

<p>Nada. Good.</p>
<p>Un petit coup de <code>man setcap</code> nous liste les permissions utilisables, et on peut voire que <code>CAP_NET_BIND_SERVICE</code> est la permission qui permet d&#8217;autoriser un exécutable à binder n&#8217;importe quel port. </p>
<p>On rajoute les permissions :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> setcap <span style="color: #007800;">cap_net_bind_service</span>=+ep <span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">which</span> python<span style="color: #000000; font-weight: bold;">`</span></pre></td></tr></table></div>

<p>On check que les permissions ont bien été ajoutées :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;">$ sudo getcap `which python`
/home/sam/.<span style="color: black;">local</span>/share/virtualenvs/super_projet/bin/python <span style="color: #66cc66;">=</span> cap_net_bind_service+eip</pre></td></tr></table></div>

<p>On a rajouté avec le <code>+</code> la permission <code>cap_net_bind_service</code> pour les cas <code>e</code> et <code>p</code> qui correspondent aux premières lettres de ces définitions :</p>
<pre>
Permitted (formerly known as forced):
    These capabilities are automatically permitted to the thread, regardless of the thread's inheritable capabilities. 

Inheritable (formerly known as allowed):
    This set is ANDed with the thread's inheritable set to determine which inheritable capabilities are enabled in the permitted set of the thread after the execve(2). 

Effective:
    This is not a set, but rather just a single bit. If this bit is set, then during an execve(2) all of the new permitted capabilities for the thread are also raised in the effective set. If this bit is not set, then after an execve(2), none of the new permitted capabilities is in the new effective set.
</pre>
<p>Et je n&#8217;ai absolument rien compris à celles-ci, je sais juste que ça marche.</p>
<p>Voilà, maintenant tout ce que vous lancez avec le Python de ce virtualenv peut se binder au port 80.</p>
<p>Si vous n&#8217;aimez pas l&#8217;idée de donner cette permission à tout un Python, il existe une alternative : rediriger tout ce qui rentre sur le port 80 vers un autre port. </p>
<p>Pour ça on peut utiliser un autre soft :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> socat</pre></td></tr></table></div>

<p>Par exemple, balancer tout le trafic du port <code>80</code> vers le port <code>8080</code> :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">socat tcp-listen:<span style="color: #000000;">80</span>,fork,reuseaddr tcp:localhost:<span style="color: #000000;">8080</span></pre></td></tr></table></div>

<p>Et pouf, votre appli qui écoute sur le port <code>8080</code> reçoit le trafic du port <code>80</code>.</p>
<p>C&#8217;est plus simple, mais il faut le faire pour chaque port, et s&#8217;assurer que la commande est bien lancée au démarrage du serveur.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ecouter-sur-le-port-80-sans-etre-root/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2015/01/5448b43a23db2b0525bdf2f2fe7f80a1.png" length="150421" type="image/jpg" />	</item>
		<item>
		<title>Black awk down 8</title>
		<link>http://sametmax.com/black-awk-down/</link>
		<comments>http://sametmax.com/black-awk-down/#comments</comments>
		<pubDate>Tue, 06 Jan 2015 10:26:20 +0000</pubDate>
		<dc:creator><![CDATA[foX]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Gadget]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[shell]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10493</guid>
		<description><![CDATA[Qui n'a jamais rêvé d'avoir un shell Unix un peu plus pythonic ? Les oneliners en sed et Awk bien chiadés, c'est l'apanage des grands barbus en sandales et ça déchire, mais ça reste cryptique et la manipulation de liste et de chaînes de caractères est tout de même limitée.]]></description>
				<content:encoded><![CDATA[<blockquote><p>Ceci est un post invité de <a href="http://sametmax.com/author/foX" target="_blank">foX </a>posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">creative common 3.0 unported</a>.</p></blockquote>
<h2>Introduction (sans douleur)</h2>
<p>Qui n&#8217;a jamais rêvé d&#8217;avoir un shell Unix un peu plus pythonic ? Les oneliners en <a href="http://fr.wikipedia.org/wiki/Stream_Editor" title="sed">sed</a> et <a href="http://fr.wikipedia.org/wiki/Awk" title="Awk">Awk</a> bien chiadés, c&#8217;est l&#8217;apanage des grands barbus en sandales et ça déchire, mais ça reste cryptique et la manipulation de liste et de chaînes de caractères est tout de même limitée. On peut dégainer perl en one line, comme ça c&#8217;est encore plus puissant mais moins lisible&#8230;</p>
<p>Et python dans tout ça ? En oneliner, ça craint, car le principe d&#8217;indentation ne facilite pas les choses et on finit avec une imbrication de bazar de parenthèses illisible.</p>
<p>La solution ? Pour se faire plaisir : une bonne pyp. Le bidule s&#8217;installe avec&#8230; pip (c&#8217;est une méta pipe).</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">pip <span style="color: #c20cb9; font-weight: bold;">install</span> pyp</pre></td></tr></table></div>

<p>pyp (<a href="http://code.google.com/p/pyp/" title="pyp">Python Power at the Prompt</a>) va enchanter votre shell unix et vous envoyer au 7ème ciel. Petit tour d&#8217;horizon de la merveille.</p>
<h2>Pyp et les strings</h2>
<p>C&#8217;est la base quand on bricole des oneliners en shell, tripoter des strings.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span></pre></td></tr></table></div>

<p>Revoyons l&#8217;action au ralenti : </p>
<ul>
<li>ls *JPG va nous lister tous les fichiers qui finissent par JPG dans le dossier courant.</li>
<li>Ensuite on envoie cela dans pyp avec un pipe Unix. Celui-ci va composer une ligne de commande qui est la concaténation d&#8217;une commande unix (mv pour renommer un fichier), ce qu&#8217;on aura reçu en entrée (qui s&#8217;appelle par convention &#8220;p&#8221;) et une version modifiée de p où l&#8217;on remplace JPG par jpg.</li>
</ul>
<p>On voit ici que l&#8217;on utilise la méthode replace de la classe str python. On peut utiliser n&#8217;importe quelle méthode de str : lower, upper, title, strip(tease), count etc. Avec des petits bonus comme refindall(re) :-)</p>
<p>Ça donne quoi ma brave dame ? Et bien si on avait des fichiers appelés porn1.JPG et ass.JPG notre jolie commande renverrait :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">mv</span> porn1.JPG porn1.jpg
<span style="color: #c20cb9; font-weight: bold;">mv</span> ass.JPG ass.jpg</pre></td></tr></table></div>

<p>Ok, bien gentil me direz-vous, mais qu&#8217;en fait-on ? Et bien ou l&#8217;on pipe ça dans le shell ( | sh) ou alors on passe l&#8217;argument -x (ou &#8211;execute) à pyp ou directement exécuter le résultat.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">sh</span>
<span style="color: #666666; font-style: italic;"># ou bien</span>
<span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">*</span>JPG <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #660033;">-x</span> <span style="color: #ff0000;">&quot;'mv', p, p.replace('JPG', 'jpg')&quot;</span></pre></td></tr></table></div>

<p>Pourquoi on aime bien python ? Car il slice le bread comme un chef. Pyp aussi, oeuf corse, quelques exemples :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;p.split('-')[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># max</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># La même chose en plus court. Le m, comme minus, sous-entend qu'on split sur &quot;-&quot;</span>
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;m[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># max</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam-et-max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;m[0], m[2]&quot;</span>
<span style="color: #666666; font-style: italic;"># sam max</span></pre></td></tr></table></div>

<p>Comme vous avez vu, il y a un petit raccourci sympa avec m (comme minus) au lieu de p. C&#8217;est pas fini, vous en avez d&#8217;autres : d (dot) pour un point, w (whitespace) pour une espace, u pour underscore, s pour slash&#8230; Ils ont pensé à tout.</p>
<h2>Des pyp à la chaîne</h2>
<p>On tout de suite envie de remettre le couvert avec une autre pyp. C&#8217;est possible et même encouragé. Le symbole utilisé est le pipe unix | dans une commande pyp. Ce n&#8217;est donc pas un pipe du shell mais un pipe interne de pyp. Vous suivez ? Un petit exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam et max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[0] | 'avant : ', o, 'après :', p&quot;</span>
<span style="color: #666666; font-style: italic;"># avant :  sam et max après : sam</span></pre></td></tr></table></div>

<p>Le p représente toujours le paramètre courant. Donc dans la seconde partie du pipe, c&#8217;est le premier élément de la liste issu du split de la chaîne &#8220;sam et max&#8221; sur l&#8217;espace (w comme whitespace). Vous suivez toujours ? Oui, bon. Et donc le o ? Et bien c&#8217;est le paramètre d&#8217;origine non modifié. Et il y a h (comme history ou comme hâlibi !) pour avoir le paramètre p à toutes les étapes de la chaîne de pipe&#8230; Beaucoup de puissance on vous dit !</p>
<p>On peut aussi rouler^w faire des join facilement avec les mêmes raccourcis. Par exemple on split sur les espaces puis join sur slash :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;sam et max aiment le lourd en fin de soirée&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[:6]|s&quot;</span>
<span style="color: #666666; font-style: italic;"># sam/et/max/aiment/le/lourd</span></pre></td></tr></table></div>

<h2>Une liste de pyp avec une belle pp</h2>
<p>S&#8217;il y a un bien un truc qui envoie du bois avec python, c&#8217;est la gestion des listes. Pyp n&#8217;est pas en reste. C&#8217;est pp qui contient les listes. En avant :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp[3]&quot;</span>
<span style="color: #666666; font-style: italic;"># Affiche le troisième fichier</span></pre></td></tr></table></div>

<p>On peut utiliser toutes les méthodes standards de la classe list (sort, count etc.) plus quelques bonus :</p>
<p># Équivalent de | sort | uniq</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ls</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp.uniq()&quot;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Additionne tous les PID des process de machine.</span>
<span style="color: #666666; font-style: italic;"># Ça ne sert à rien, mais c'est un exemple hein ?</span>
<span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | sum(pp)&quot;</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># Voilà qui est plus utile. </span>
<span style="color: #666666; font-style: italic;"># Au passage, on note que la ligne d'en-tête est ignoré et ne fait pas planter pyp.</span>
<span style="color: #666666; font-style: italic;"># Malin le lapin.</span>
<span style="color: #c20cb9; font-weight: bold;">df</span> <span style="color: #660033;">-m</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | sum(pp)&quot;</span></pre></td></tr></table></div>

<h2>pyp au naturel</h2>
<p>Pour compléter les fonctions python, pyp propose quelques fonctions maisons tout à fait sympathiques. Florilège :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;Sam Bill Max&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;p.kill('Bill')&quot;</span>  <span style="color: #666666; font-style: italic;"># quand c'est pas bill, c'est kenny...</span>
<span style="color: #666666; font-style: italic;"># Sam  Max</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #000000;">124</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;(int(p)/2+30)&quot;</span>
<span style="color: #666666; font-style: italic;"># 91</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ls</span>  <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;n, p&quot;</span>
<span style="color: #666666; font-style: italic;"># Liste des fichiers avec un numéro croissant devant</span>
&nbsp;
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>fox<span style="color: #000000; font-weight: bold;">/</span>video<span style="color: #000000; font-weight: bold;">/</span>gangbang.avi  <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;'Dir='+p.dir, '<span style="color: #000099; font-weight: bold;">\n</span>File='+p.file, '<span style="color: #000099; font-weight: bold;">\n</span>Ext='+p.ext&quot;</span> <span style="color: #666666; font-style: italic;"># basename, dirname et ses amis</span>
<span style="color: #666666; font-style: italic;"># Dir=/home/fox/video </span>
<span style="color: #666666; font-style: italic;"># File=gangbang.avi </span>
<span style="color: #666666; font-style: italic;"># Ext=avi</span>
&nbsp;
<span style="color: #666666; font-style: italic;"># On définit le séparateur de liste comme l'espace, </span>
<span style="color: #666666; font-style: italic;"># puis on regroupe la liste par deux élément</span>
<span style="color: #666666; font-style: italic;"># et enfin on fait un join sur le caractère tiret (minus)</span>
<span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;1 2 3 4 5 6&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;pp.delimit(' ') | pp.divide(2) | m&quot;</span>
<span style="color: #666666; font-style: italic;"># 1-2</span>
<span style="color: #666666; font-style: italic;"># 3-4</span>
<span style="color: #666666; font-style: italic;"># 5-6</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | max(pp)&quot;</span> 
<span style="color: #666666; font-style: italic;"># (le PID le plus grand)</span></pre></td></tr></table></div>

<h2>pyp en intention ou intention de pyp ?</h2>
<p>Il ne faut pas se gêner, on peut utiliser les excellentes <a href="http://sametmax.com/python-love-les-listes-en-intention-partie/" title="Listes en intention">listes en intention</a> de Python.  Voici tous les PID impaires :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | [i for i in pp if i%2] | p &quot;</span></pre></td></tr></table></div>

<h2>L&#8217;industrie de la pyp c&#8217;est un truc de macro</h2>
<p>Les bonnes choses, ça se garde, alors voilà :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">ps</span> <span style="color: #660033;">-ef</span> <span style="color: #000000; font-weight: bold;">|</span> pyp <span style="color: #ff0000;">&quot;w[1] | int(p) | [i for i in pp if i%2] | p &quot;</span> <span style="color: #660033;">-s</span> odd  <span style="color: #666666; font-style: italic;"># on enregistre la macro 'odd'</span>
&nbsp;
<span style="color: #c20cb9; font-weight: bold;">ps</span> ef <span style="color: #000000; font-weight: bold;">|</span> pyp odd <span style="color: #666666; font-style: italic;"># c'est aussi simple que cela ;-)</span></pre></td></tr></table></div>

<h2>pyp sur grand écran</h2>
<p>Cette petite pépite est développée par Sony Pictures Imageworks pour ses besoins internes. Le développement n&#8217;est pas très collaboratif (un commit par release&#8230;) mais reste ouvert aux contributions externes. C&#8217;est sous une licence de type BSD.<br />
Les loulous ont fait une jolie vidéo de tutorial très bling bling. C&#8217;est l&#8217;avantage de bosser dans le milieu : </p>
<p><span class='embed-youtube' style='text-align:center; display: block;'><iframe class='youtube-player' type='text/html' width='1170' height='689' src='http://www.youtube.com/embed/eWtVWF0JSJA?version=3&#038;rel=1&#038;fs=1&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' frameborder='0' allowfullscreen='true'></iframe></span></p>
<h2>Et bien plus encore&#8230;</h2>
<p>Cet outil merveilleux possède encore des fonctionnalités qui vont vous le faire adorer comme son mode interactif avec une coloration syntaxique sympathique, la gestion de l&#8217;historique dans le pipe et beaucoup d&#8217;autres. Adieu sed, awk, uniq, sort et con sort, vous étiez mes premiers amours, mais pyp vous chasse dehors.</p>
<p>Ce n&#8217;est pas la seule ni la première tentative de faire la peau d&#8217;awk avec python. Sam avait déjà écrit <a href="http://sametmax.com/remplacer-sed-awk-cut-et-perl-par-python-orgasme-pour-sysadmin/" title="une pyped pour Sam">un article </a>sur une autre solution aussi appelée pyped.</p>
<h2> C&#8217;est donc parfait ? </h2>
<p>Oui, bien entendu. Aucun défaut, aucun bug. Ok&#8230; voici les limites : </p>
<ul>
<ol>Perf de daube. Sur des petits volumes (quelques milliers de lignes) ça le fait. Au delà, ça rame. Quelques patch sont proposés pour diviser par trois le temps de traitement :-)</ol>
<ol>Conso mémoire obcène. Idem, pour des petits volumes on s&#8217;en fout, mais sinon ça peut rapidement chiffrer. Pourquoi ? Le machin ne fonctionne pas en stream, tout est gardé en mémoire et à chaque étape de transformation (pour permettre d&#8217;accéder à l&#8217;historique).</ol>
<ol>C&#8217;est installé sur votre pc, mais pas partout, contrairement à ce bon vieux awk. </ol>
</ul>
<p>Amusez vous bien, celui qui fait la plus jolie commande pyp dans les commentaires aura le droit à un bisous.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/black-awk-down/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/06/hawk.jpg" length="364221" type="image/jpg" />	</item>
		<item>
		<title>Explication de code : python-mss 9</title>
		<link>http://sametmax.com/explication-de-code-python-mss/</link>
		<comments>http://sametmax.com/explication-de-code-python-mss/#comments</comments>
		<pubDate>Sat, 22 Feb 2014 14:19:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[mac]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[screenshot]]></category>
		<category><![CDATA[windows]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=9219</guid>
		<description><![CDATA[Ca faisait longtemps qu'on avait pas eu une petite explication de code dans le cadre de notre politique "<a href="http://sametmax.com/notre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu/">envoyez nous les codes que vous ne pigez pas</a>".

Celle-ci est un peu particulière.]]></description>
				<content:encoded><![CDATA[<p>Ca faisait longtemps qu&#8217;on avait pas eu une petite explication de code dans le cadre de notre politique &#8220;<a href="http://sametmax.com/notre-programme-envoyez-nous-les-scripts-que-vous-ne-pigez-pas-est-toujours-dactu/">envoyez nous les codes que vous ne pigez pas</a>&#8220;.</p>
<p>Celle-ci est un peu particulière.</p>
<p>D&#8217;abord parce qu&#8217;elle traine dans la boîte mail depuis un siècle ou deux. Je pense que l&#8217;auteur de la demande n&#8217;en a plus besoin&#8230;</p>
<p>Ensuite parce que le code est assez complexe, notamment à cause de l&#8217;utilisateur d&#8217;API C. Donc si vous n&#8217;avez pas des notions de C, vous n&#8217;allez rien piger. En effet je ne vais pas expliquer les bases de C ou de Python, ce n&#8217;est pas un tuto, donc il me faut des prérequis. Je vous invite quand même à vous rafraichir la mémoire en utilisant notre <a href="http://sametmax.com/appeler-du-code-c-depuis-python-avec-ctypes/">introduction au module ctypes</a> car il est massivement utilisé dans ce code.</p>
<p>Exceptionnellement, je ne vais pas pondre de version alternative car :</p>
<ul>
<li>le code est très très long, et j&#8217;ai déjà passé mon samedi matin à écrire cet article.</li>
<li>je n&#8217;ai pas de mac pour tester cette partie.</li>
</ul>
<p>Comme d&#8217;habitude, je vais faire des remarques parfois critiques sur le code, mais mon intention n&#8217;est bien entendu pas de faire du tord à l&#8217;auteur. C&#8217;est pédagogique pour les lecteurs. D&#8217;ailleurs ce bout de code est assez impressionnant et a du demander des heures et des heures de travail tant au niveau du code que de la recherche d&#8217;information. J&#8217;insiste donc sur mon respect pour l&#8217;auteur. On est pas sur bashfr.</p>
<p>Je tiens tout de même à prévenir que la lib ne fonctionne pas sur ma machine, plante sur certains appels, ou produits des screenshots illisibles. Je ne doute néanmoins pas de la compétence de l&#8217;auteur, ce qu&#8217;il essaye de faire est vraiment compliqué, et ne pense que Python n&#8217;est pas son premier langage.</p>
<p>On m&#8217;a signalé dans le twitcoutuer qu&#8217;il manque de la zik :</p>

<!-- iframe plugin v.2.9 wordpress.org/plugins/iframe/ -->
<iframe width="420" height="315" src="//www.youtube.com/embed/RV2NKk1ATew" frameborder="0" scrolling="no" class="iframe-class"></iframe>

<p>Normalement le but de la lib est de permettre de faire des screenshots en pure Python sous Windows, Linux et Mac. Exemple de code sous Linux :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> mss <span style="color: #ff7700;font-weight:bold;">import</span> MSSLinux
<span style="color: #66cc66;">&gt;&gt;&gt;</span> mss <span style="color: #66cc66;">=</span> MSSLinux<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> screnshots <span style="color: #66cc66;">=</span> mss.<span style="color: black;">save</span><span style="color: black;">&#40;</span>output<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'/tmp/screenshots'</span><span style="color: #66cc66;">,</span> oneshot<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">list</span><span style="color: black;">&#40;</span>screnshots<span style="color: black;">&#41;</span>
<span style="color: black;">&#91;</span>u<span style="color: #483d8b;">'/tmp/screenshots-full.png'</span><span style="color: black;">&#93;</span></pre></td></tr></table></div>

<p>Et voici le code commenté. C&#8217;est un gros morceau, et bien complexes, avec des notions parfois que je ne maitrise pas. J&#8217;ai pu faire des erreurs et dire des bêtises. Si l&#8217;auteur passe par là, il a bien entendu un droit de réponse.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">#!/usr/bin/env python</span>
<span style="color: #808080; font-style: italic;"># -*- coding: utf-8 -*-</span>
&nbsp;
<span style="color: #483d8b;">''' A cross-platform multi-screen shot module in pure python using ctypes.
&nbsp;
    This module is maintained by Mickaël Schoentgen &lt;contact@tiger-222.fr&gt;.
    If you find problems, please submit bug reports/patches via the
    GitHub issue tracker (https://github.com/BoboTiG/python-mss/issues).
&nbsp;
    Note: please keep this module compatible to Python 2.6.
&nbsp;
    Still needed:
    * support for additional systems
&nbsp;
    Many thanks to all those who helped (in no particular order):
&nbsp;
      Oros, Eownis
&nbsp;
    History:
&nbsp;
    &lt;see Git checkin messages for history&gt;
&nbsp;
    0.0.1 - first release
    0.0.2 - add support for python 3 on Windows and GNU/Linux
    0.0.3 - MSSImage: remove PNG filters
          - MSSImage: remove 'ext' argument, using only PNG
          - MSSImage: do not overwrite existing image files
          - MSSImage: few optimizations into png()
          - MSSLinux: few optimizations into get_pixels()
    0.0.4 - MSSLinux: use of memoization =&gt; huge time/operations gains
    0.0.5 - MSSWindows: few optimizations into _arrange()
          - MSSImage: code simplified
&nbsp;
    You can always get the latest version of this module at:
&nbsp;
            https://raw.github.com/BoboTiG/python-mss/master/mss.py
&nbsp;
    If that URL should fail, try contacting the author.
'''</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">__future__</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>unicode_literals<span style="color: #66cc66;">,</span> absolute_import<span style="color: #66cc66;">,</span>
                        division<span style="color: #66cc66;">,</span> print_function<span style="color: black;">&#41;</span>
&nbsp;
__version__ <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'0.0.5'</span>
__author__ <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">&quot;Mickaël 'Tiger-222' Schoentgen&quot;</span>
__copyright__ <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'''
    Copyright (c) 2013, Mickaël 'Tiger-222' Schoentgen
&nbsp;
    Permission to use, copy, modify, and distribute this software and its
    documentation for any purpose and without fee or royalty is hereby
    granted, provided that the above copyright notice appear in all copies
    and that both that copyright notice and this permission notice appear
    in supporting documentation or portions thereof, including
    modifications, that you make.
'''</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Bon je vais pas vous expliquer ce que les lignes du dessus font hein...hein</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># __all__ liste les objets importables si on fait from mss import *</span>
<span style="color: #808080; font-style: italic;"># ce qui limite la pollution du namespace avec tout un tas de choses inutiles</span>
<span style="color: #808080; font-style: italic;"># comme pack, isfile, system, etc. qui sont quelques lignes plus bas.</span>
__all__ <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">'MSSImage'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'MSSLinux'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'MSSMac'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'MSSWindows'</span><span style="color: black;">&#93;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Permet de trouve une bibliothèqe via son nom sur le système en cherchant</span>
<span style="color: #808080; font-style: italic;"># divers chemins standard à l'OS</span>
<span style="color: #ff7700;font-weight:bold;">from</span> ctypes.<span style="color: black;">util</span> <span style="color: #ff7700;font-weight:bold;">import</span> find_library
&nbsp;
<span style="color: #808080; font-style: italic;"># Permet une forme de sérialisation des types simples qui est compatible</span>
<span style="color: #808080; font-style: italic;"># entre Python et C</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">struct</span> <span style="color: #ff7700;font-weight:bold;">import</span> pack
&nbsp;
<span style="color: #808080; font-style: italic;"># Permet de vérifier si un fichier existe et n'est pas un dossier</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span> <span style="color: #ff7700;font-weight:bold;">import</span> isfile
&nbsp;
<span style="color: #808080; font-style: italic;"># Permet de récupérer le nom de l'OS</span>
<span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">platform</span> <span style="color: #ff7700;font-weight:bold;">import</span> system
&nbsp;
<span style="color: #808080; font-style: italic;"># Divers opérations sur le système</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Compression zip</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">zlib</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On importe conditionnellement des packages selon le système sur lequel on</span>
<span style="color: #808080; font-style: italic;"># est. La raison de cela est que certains packages n'existe pas (ou ne sont pas</span>
<span style="color: #808080; font-style: italic;"># utiles) sur certains OS.</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Darwin, c'est l'OS open source qui sert de base au Mac. C'est</span>
<span style="color: #808080; font-style: italic;"># un mélange de NeXTSTEP et de FreeBSD.</span>
<span style="color: #ff7700;font-weight:bold;">if</span> system<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'Darwin'</span>:
    <span style="color: #808080; font-style: italic;"># Quartz est la techno derrière l'affichage des Mac incluant notament</span>
    <span style="color: #808080; font-style: italic;"># le compositeur graphique et moteur de rendu 2D. Il a un binding Python</span>
    <span style="color: #808080; font-style: italic;"># intégré puisque les Mac utilisent Python un peu partout. A ce demander</span>
    <span style="color: #808080; font-style: italic;"># pourquoi ces neuneus nous ont collé objectifs C pour le dev.</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> Quartz <span style="color: #ff7700;font-weight:bold;">import</span> *
    <span style="color: #808080; font-style: italic;"># On importe juste l'équivalent du mimetype sous Mac pour le PNG. C'est</span>
    <span style="color: #808080; font-style: italic;"># une &quot;constante&quot;</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> LaunchServices <span style="color: #ff7700;font-weight:bold;">import</span> kUTTypePNG
&nbsp;
&nbsp;
<span style="color: #ff7700;font-weight:bold;">elif</span> system<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'Linux'</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Accès aux variables d'environnement</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">os</span> <span style="color: #ff7700;font-weight:bold;">import</span> environ
    <span style="color: #808080; font-style: italic;"># Fonction pour transformer ~ dans les chemin d'accès en chemin vers</span>
    <span style="color: #808080; font-style: italic;"># le dossier utilisateur</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span> <span style="color: #ff7700;font-weight:bold;">import</span> expanduser
    <span style="color: #808080; font-style: italic;"># Parseur de xml</span>
    <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">xml</span>.<span style="color: black;">etree</span>.<span style="color: black;">ElementTree</span> <span style="color: #ff7700;font-weight:bold;">as</span> ET
&nbsp;
    <span style="color: #808080; font-style: italic;"># 'byref' permet d'obtenir un pointer sur une fonction c,</span>
    <span style="color: #808080; font-style: italic;"># 'cast' est similaire à l'opérateur cast en c et permet le type casting</span>
    <span style="color: #808080; font-style: italic;"># d'un objet c, 'cdll' permet de charger des shared lib C</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> ctypes <span style="color: #ff7700;font-weight:bold;">import</span> byref<span style="color: #66cc66;">,</span> cast<span style="color: #66cc66;">,</span> cdll
&nbsp;
    <span style="color: #808080; font-style: italic;"># je ne sais pas pourquoi ça n'a pas été fait une seule ligne...</span>
    <span style="color: #808080; font-style: italic;"># Tout ça représente les types c éponymes, mais en plus Structure est une</span>
    <span style="color: #808080; font-style: italic;"># classe abstraite dont on peut hériter faire une classe qui peut être</span>
    <span style="color: #808080; font-style: italic;"># passée en paramètre à une fonction C qui attend un struc.</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> ctypes <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>
        c_char_p<span style="color: #66cc66;">,</span> c_int<span style="color: #66cc66;">,</span> c_int32<span style="color: #66cc66;">,</span> c_uint<span style="color: #66cc66;">,</span> c_uint32<span style="color: #66cc66;">,</span>
        c_ulong<span style="color: #66cc66;">,</span> c_void_p<span style="color: #66cc66;">,</span> POINTER<span style="color: #66cc66;">,</span> Structure
    <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On hérite de Structure ce qui nous fait pour le moment une structure</span>
    <span style="color: #808080; font-style: italic;"># vide</span>
    <span style="color: #ff7700;font-weight:bold;">class</span> Display<span style="color: black;">&#40;</span>Structure<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Une structure représentant les attributs d'une fenêtre pour le serveur</span>
    <span style="color: #808080; font-style: italic;"># d'affichage sous Linux.</span>
    <span style="color: #ff7700;font-weight:bold;">class</span> XWindowAttributes<span style="color: black;">&#40;</span>Structure<span style="color: black;">&#41;</span>:
        _fields_ <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'x'</span><span style="color: #66cc66;">,</span>                     c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'y'</span><span style="color: #66cc66;">,</span>                     c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'width'</span><span style="color: #66cc66;">,</span>                 c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'height'</span><span style="color: #66cc66;">,</span>                c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'border_width'</span><span style="color: #66cc66;">,</span>          c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'depth'</span><span style="color: #66cc66;">,</span>                 c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'visual'</span><span style="color: #66cc66;">,</span>                c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'root'</span><span style="color: #66cc66;">,</span>                  c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'class'</span><span style="color: #66cc66;">,</span>                 c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bit_gravity'</span><span style="color: #66cc66;">,</span>           c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'win_gravity'</span><span style="color: #66cc66;">,</span>           c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'backing_store'</span><span style="color: #66cc66;">,</span>         c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'backing_planes'</span><span style="color: #66cc66;">,</span>        c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'backing_pixel'</span><span style="color: #66cc66;">,</span>         c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'save_under'</span><span style="color: #66cc66;">,</span>            c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'colourmap'</span><span style="color: #66cc66;">,</span>             c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'mapinstalled'</span><span style="color: #66cc66;">,</span>          c_uint32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'map_state'</span><span style="color: #66cc66;">,</span>             c_uint32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'all_event_masks'</span><span style="color: #66cc66;">,</span>       c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'your_event_mask'</span><span style="color: #66cc66;">,</span>       c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'do_not_propagate_mask'</span><span style="color: #66cc66;">,</span> c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'override_redirect'</span><span style="color: #66cc66;">,</span>     c_int32<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'screen'</span><span style="color: #66cc66;">,</span>                c_ulong<span style="color: black;">&#41;</span>
        <span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># structure définissant une image telle qu'elle existe dans la mémoire</span>
    <span style="color: #808080; font-style: italic;"># d'un client du serveur d'affichage</span>
    <span style="color: #ff7700;font-weight:bold;">class</span> XImage<span style="color: black;">&#40;</span>Structure<span style="color: black;">&#41;</span>:
        _fields_ <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'width'</span>            <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'height'</span>           <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'xoffset'</span>          <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'format'</span>           <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'data'</span>             <span style="color: #66cc66;">,</span> c_char_p<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'byte_order'</span>       <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bitmap_unit'</span>      <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bitmap_bit_order'</span> <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bitmap_pad'</span>       <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'depth'</span>            <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bytes_per_line'</span>   <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bits_per_pixel'</span>   <span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'red_mask'</span>         <span style="color: #66cc66;">,</span> c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'green_mask'</span>       <span style="color: #66cc66;">,</span> c_ulong<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'blue_mask'</span>        <span style="color: #66cc66;">,</span> c_ulong<span style="color: black;">&#41;</span>
        <span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Apparement la fonction pack avec ce format va être appelée souvent</span>
    <span style="color: #808080; font-style: italic;"># doc l'auteur se fait un raccourci. Le format en question est 'B', donc</span>
    <span style="color: #808080; font-style: italic;"># du unsigned char, et '&lt;', donc du little endian. Et là vous comprenez</span>
    <span style="color: #808080; font-style: italic;"># le bonheur de travailler dans un langage de haut niveau comme Python.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> b<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">return</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&lt;B'</span><span style="color: #66cc66;">,</span> x<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">elif</span> system<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'Windows'</span>:
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">from</span> ctypes <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># 'memset' fait pareil que memset en C : on rempli un bloc de mémoire</span>
        <span style="color: #808080; font-style: italic;"># avec les bytes passés en param mais il n'est pas utilisé dans le code,</span>
        <span style="color: #808080; font-style: italic;"># donc je suppose que c'est un oubli. 'pointer' va créer une instance de</span>
        <span style="color: #808080; font-style: italic;"># la classe qui permet de manipuler un pointer sur un type c en Python.</span>
        <span style="color: #808080; font-style: italic;"># 'sizeof', même chose que l'opérateur c, ça retourne la taille en bytes</span>
        <span style="color: #808080; font-style: italic;"># d'un type</span>
        <span style="color: #808080; font-style: italic;"># c. 'windll', comme 'cdll' plus haut, mais l'appel des fonctions suit</span>
        <span style="color: #808080; font-style: italic;"># la convention stdcall typique de la win32api et pas la convention c</span>
        <span style="color: #808080; font-style: italic;"># standard.</span>
        byref<span style="color: #66cc66;">,</span> memset<span style="color: #66cc66;">,</span> pointer<span style="color: #66cc66;">,</span> sizeof<span style="color: #66cc66;">,</span> windll<span style="color: #66cc66;">,</span>
        <span style="color: #808080; font-style: italic;"># Représentation du type void en c, aliasé sous deux noms. Je n'ai pas</span>
        <span style="color: #808080; font-style: italic;"># vraiment compris l'interêt de le faire, excepté pour explicitement</span>
        <span style="color: #808080; font-style: italic;"># montrer quand on l'utilise dans un appel qui attend LPRECT (un pointer</span>
        <span style="color: #808080; font-style: italic;"># sur une struc qui représente un rectangle ou un pointer sur void)</span>
        c_void_p <span style="color: #ff7700;font-weight:bold;">as</span> LPRECT<span style="color: #66cc66;">,</span>
        c_void_p <span style="color: #ff7700;font-weight:bold;">as</span> LPVOID<span style="color: #66cc66;">,</span>
        <span style="color: #808080; font-style: italic;"># créer un array de char en c</span>
        create_string_buffer<span style="color: #66cc66;">,</span>
        <span style="color: #808080; font-style: italic;"># ça on a vu</span>
        Structure<span style="color: #66cc66;">,</span>
        POINTER<span style="color: #66cc66;">,</span>
        <span style="color: #808080; font-style: italic;"># Ceci est une fonction. Pourquoi c'est en majuscule, je n'en sais rien.</span>
        <span style="color: #808080; font-style: italic;"># Une incohérence dans l'API. En tout cas ça permet de retourner</span>
        <span style="color: #808080; font-style: italic;"># un prototype de fonction qui respecte la convention stdcall.</span>
        WINFUNCTYPE<span style="color: #66cc66;">,</span>
    <span style="color: black;">&#41;</span>
    <span style="color: #808080; font-style: italic;"># Des &quot;constantes&quot; qui représentent des types spécifiques à l'API widows</span>
    <span style="color: #808080; font-style: italic;"># Notez que le PEP8 n'est pas respecté, mais bon, vu la taille du code,</span>
    <span style="color: #808080; font-style: italic;"># il y a forcément des coquilles, c'est normal. Certains comme SHORT</span>
    <span style="color: #808080; font-style: italic;"># et HANDLE ne sont pas utilisés.</span>
    <span style="color: #ff7700;font-weight:bold;">from</span> ctypes.<span style="color: black;">wintypes</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: black;">&#40;</span>
        BOOL<span style="color: #66cc66;">,</span> DOUBLE<span style="color: #66cc66;">,</span> DWORD<span style="color: #66cc66;">,</span> HANDLE<span style="color: #66cc66;">,</span> HBITMAP<span style="color: #66cc66;">,</span> HDC<span style="color: #66cc66;">,</span> HGDIOBJ<span style="color: #66cc66;">,</span>
        HWND<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> LPARAM<span style="color: #66cc66;">,</span> LONG<span style="color: #66cc66;">,</span>RECT<span style="color: #66cc66;">,</span>SHORT<span style="color: #66cc66;">,</span> UINT<span style="color: #66cc66;">,</span> WORD
    <span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Structure contenant les information sur les dimentions et la couleur</span>
    <span style="color: #808080; font-style: italic;"># d'un BMP (on appelle ça aussi un bitmap ou DIB, donc dans les docs</span>
    <span style="color: #808080; font-style: italic;"># vous verrez l'une ou l'autre de ces appellations)</span>
    <span style="color: #ff7700;font-weight:bold;">class</span> BITMAPINFOHEADER<span style="color: black;">&#40;</span>Structure<span style="color: black;">&#41;</span>:
        _fields_ <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biSize'</span><span style="color: #66cc66;">,</span>          DWORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biWidth'</span><span style="color: #66cc66;">,</span>         LONG<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biHeight'</span><span style="color: #66cc66;">,</span>        LONG<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biPlanes'</span><span style="color: #66cc66;">,</span>        WORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biBitCount'</span><span style="color: #66cc66;">,</span>      WORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biCompression'</span><span style="color: #66cc66;">,</span>   DWORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biSizeImage'</span><span style="color: #66cc66;">,</span>     DWORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biXPelsPerMeter'</span><span style="color: #66cc66;">,</span> LONG<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biYPelsPerMeter'</span><span style="color: #66cc66;">,</span> LONG<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biClrUsed'</span><span style="color: #66cc66;">,</span>       DWORD<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'biClrImportant'</span><span style="color: #66cc66;">,</span>  DWORD<span style="color: black;">&#41;</span>
        <span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Un wrapper sur la structure précédente, je suppose nécessaire pour</span>
    <span style="color: #808080; font-style: italic;"># être compatible avec une des bizarreries de l'API windows.</span>
    <span style="color: #ff7700;font-weight:bold;">class</span> BITMAPINFO<span style="color: black;">&#40;</span>Structure<span style="color: black;">&#41;</span>:
        _fields_ <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bmiHeader'</span><span style="color: #66cc66;">,</span> BITMAPINFOHEADER<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            <span style="color: black;">&#40;</span><span style="color: #483d8b;">'bmiColors'</span><span style="color: #66cc66;">,</span> DWORD * <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>
        <span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Là j’avoue je ne comprends pas trop le principe. Il tente de vérifier</span>
    <span style="color: #808080; font-style: italic;"># si le système est du Python 2, si oui il ne caste pas la string en bytes</span>
    <span style="color: #808080; font-style: italic;"># car le type de base des strings est déjà de type bytes (ce qui n'est</span>
    <span style="color: #808080; font-style: italic;"># pas le cas en Python 3 : c'est un type unicode). Donc il fabrique la</span>
    <span style="color: #808080; font-style: italic;"># fonction raccourcie selon la version. Sauf qu'il ne le fait pas</span>
    <span style="color: #808080; font-style: italic;"># dans la condition pour linux. Du coup je pige pas trop comment il</span>
    <span style="color: #808080; font-style: italic;"># s'en sort. Il est compatible que 2.7 sous Linux ?</span>
    <span style="color: #808080; font-style: italic;"># Dans tous les cas ces fonctions pourraient être en dehors de la clause</span>
    <span style="color: #808080; font-style: italic;"># if, tout comme certains imports pour des raisons de DRY.</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">version</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #483d8b;">'3'</span>:
        <span style="color: #ff7700;font-weight:bold;">def</span> b<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">return</span> x
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">def</span> b<span style="color: black;">&#40;</span>x<span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">return</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&lt;B'</span><span style="color: #66cc66;">,</span> x<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># Moi aussi j'adore mettre des commentaires comme ça dans mon code.mon</span>
<span style="color: #808080; font-style: italic;"># Que ceux qui n'aiment pas aillent se faire foutre.</span>
&nbsp;
&nbsp;
<span style="color: #808080; font-style: italic;"># ----------------------------------------------------------------------</span>
<span style="color: #808080; font-style: italic;"># --- [ C'est parti mon kiki ! ] ---------------------------------------</span>
<span style="color: #808080; font-style: italic;"># ----------------------------------------------------------------------</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Comme précisé dans la docstring, c'est une classe de base. Ca implemente</span>
<span style="color: #808080; font-style: italic;"># essentiellement le logging du mode debug et la logique d'enregistrement</span>
<span style="color: #808080; font-style: italic;"># des fichiers.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> MSS<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">''' This class will be overloaded by a system specific one.
        It checkes if there is a class available for the current system.
        Raise an exception if no one found.
    '''</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># De l'initialisation, pas super intéressant...</span>
    DEBUG <span style="color: #66cc66;">=</span> <span style="color: #008000;">False</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> debug<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Global vars and class overload. '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">DEBUG</span> <span style="color: #66cc66;">=</span> debug
        <span style="color: #008000;">self</span>.<span style="color: black;">monitors</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">False</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># L'init présuppose quand même qu'une classe fille a une fonction</span>
        <span style="color: #808080; font-style: italic;">#  init. Je vois pas trop l'interêt car ça peut se faire par héritage</span>
        <span style="color: #808080; font-style: italic;"># ou alors quitte à faire ça, autant faire en utilisant un système</span>
        <span style="color: #808080; font-style: italic;"># de call back sur des events genre &quot;oninit&quot;, c'est plus propre, plus</span>
        <span style="color: #808080; font-style: italic;"># découplé et ça tombe pas en marche si la fonction init() n'existe pas</span>
        <span style="color: #808080; font-style: italic;"># dans l'enfant.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">init</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Une fonction print un peut élaborée qui permet d'afficher rapidement</span>
    <span style="color: #808080; font-style: italic;"># le contenu qu'on lui passe en paramètre de manière formatté pour le debug.</span>
    <span style="color: #808080; font-style: italic;"># Utiliser le module logging aurait été préférable, mais c'est tellement</span>
    <span style="color: #808080; font-style: italic;"># chiant à setup que je comprends qu'il ait eu la flemme.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> debug<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> method<span style="color: #66cc66;">=</span><span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> scalar<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> value<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Simple debug output. '''</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">DEBUG</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> scalar <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
                <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">':: '</span> + method + <span style="color: #483d8b;">'()'</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">else</span>:
                <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>method + <span style="color: #483d8b;">'()'</span><span style="color: #66cc66;">,</span> scalar<span style="color: #66cc66;">,</span> <span style="color: #008000;">type</span><span style="color: black;">&#40;</span>value<span style="color: black;">&#41;</span>.__name__<span style="color: #66cc66;">,</span> value<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># La fonction &quot;kifétou&quot;. Elle demande la création des screenshots, les</span>
    <span style="color: #808080; font-style: italic;"># sauvegarde dans des fichiers png dans un dossier. Il aurait été sympa</span>
    <span style="color: #808080; font-style: italic;"># de découper cette fonction en sous fonctions : une prendre le screen</span>
    <span style="color: #808080; font-style: italic;"># d'un moniteur, une pour recupérer le screenshot tout forme d'objet image,</span>
    <span style="color: #808080; font-style: italic;"># etc. Là la seule option c'est &quot;tu prends tout, tu sauves tout&quot;. C'est pas</span>
    <span style="color: #808080; font-style: italic;"># très souple, et dur à tester.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> save<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> output<span style="color: #66cc66;">=</span><span style="color: #483d8b;">'mss'</span><span style="color: #66cc66;">,</span> oneshot<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' For each monitor, grab a screen shot and save it to a file.
&nbsp;
            Parameters:
             - output - string - the output filename without extension
             - oneshot - boolean - grab only one screen shot of all monitors
&nbsp;
            This is a generator which returns created files:
                'output-1.png',
                'output-2.png',
                ...,
                'output-NN.png'
                or
                'output-full.png'
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'save'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Là on voit un antipattern très courrant en POO : mettre des paramètres</span>
        <span style="color: #808080; font-style: italic;"># pour un appel de méthode directement en attribut pour toute la classe.</span>
        <span style="color: #808080; font-style: italic;"># Cela veut dire qu'un appel à cette fonction &quot;lock&quot; la classe dans</span>
        <span style="color: #808080; font-style: italic;"># un état dépendant de cet appel. En plus de réduire à néant les possibilités</span>
        <span style="color: #808080; font-style: italic;"># de multithreading et rendre les tests compliqués, ça veut dire aussi</span>
        <span style="color: #808080; font-style: italic;"># que tout débuggage doit tenir compte de l'état de la classe. Et bien</span>
        <span style="color: #808080; font-style: italic;"># entendu, ça veut dire qu'on ne peut pas avoir plusieurs états en</span>
        <span style="color: #808080; font-style: italic;"># parallèles, à moins d'instancier plusieurs classes. Il vaudrait mieux</span>
        <span style="color: #808080; font-style: italic;"># que tout ça soit passé en paramètres, quitte à faire un autre objet</span>
        <span style="color: #808080; font-style: italic;"># nommé &quot;config&quot; qui contienne tout ça.</span>
        <span style="color: #808080; font-style: italic;">#</span>
        <span style="color: #808080; font-style: italic;"># En tout cas, ça stoque le param &quot;oneshot&quot; et la liste des moniteurs</span>
        <span style="color: #808080; font-style: italic;"># retournés par le code fourni par la classe fille puisque</span>
        <span style="color: #808080; font-style: italic;"># enum_display_monitors n'est pas défini dans cette classe.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span> <span style="color: #66cc66;">=</span> oneshot
        <span style="color: #008000;">self</span>.<span style="color: black;">monitors</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">enum_display_monitors</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">or</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'save'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'oneshot'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On lève une exception si il est impossible de trouver des écrans dont</span>
        <span style="color: #808080; font-style: italic;"># on peut faire la capture, ce qui est une bonne chose. Mais une bonne</span>
        <span style="color: #808080; font-style: italic;"># pratique serait de faire :</span>
        <span style="color: #808080; font-style: italic;"># class ScreenshotError(Exception):</span>
        <span style="color: #808080; font-style: italic;">#     pass</span>
        <span style="color: #808080; font-style: italic;"># Afin d'avoir quelque chose de plus significatif que ValueError.</span>
        <span style="color: #808080; font-style: italic;"># De plus, ce code est typique d'un programmeur d'un autre langage</span>
        <span style="color: #808080; font-style: italic;"># qui apprend encore les idiomes Python car cette condition pourrait</span>
        <span style="color: #808080; font-style: italic;"># se réduire à :</span>
        <span style="color: #808080; font-style: italic;"># if not self.monitors: &lt;- pas besoin de len</span>
        <span style="color: #808080; font-style: italic;">#     raise ScreenshotError('MSS: no monitor found.'))</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">monitors</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #ff4500;">1</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSS: no monitor found.'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Monitors screen shots!</span>
        <span style="color: #808080; font-style: italic;"># On itère sur les écrans, et on fait un screen par écran. Même remarque</span>
        <span style="color: #808080; font-style: italic;"># sur le fait que l'auteur cherche encore ses marques en Python (notez</span>
        <span style="color: #808080; font-style: italic;"># bien que c'est naturel, personne n'a la science infuse et mon style</span>
        <span style="color: #808080; font-style: italic;"># est horrible dans les autres langages), car ici le compteur i est</span>
        <span style="color: #808080; font-style: italic;"># aventageusement remplacé par :</span>
        <span style="color: #808080; font-style: italic;"># for i, monitor in enumerate(self.monitors)</span>
        i <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> monitor <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">self</span>.<span style="color: black;">monitors</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'save'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'monitor'</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Si on ne fait qu'un gros screenshot, on l'appelle name-full.png</span>
            <span style="color: #808080; font-style: italic;"># sinon name-numero_du_moniteur.png</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span>:
                filename <span style="color: #66cc66;">=</span> output + <span style="color: #483d8b;">'-full'</span>
            <span style="color: #ff7700;font-weight:bold;">else</span>:
                filename <span style="color: #66cc66;">=</span> output + <span style="color: #483d8b;">'-'</span> + <span style="color: #008000;">str</span><span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span>
                i +<span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
            filename +<span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'.png'</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Si le fichier n'existe pas, on l'écrit. Ceci est encore une</span>
            <span style="color: #808080; font-style: italic;"># erreur car une API métier ne doit pas faire ce genre de</span>
            <span style="color: #808080; font-style: italic;"># vérification. Il devrait écraser les fichiers. Il est en revanche</span>
            <span style="color: #808080; font-style: italic;"># possible de mettre un système de callback pour réagir si le</span>
            <span style="color: #808080; font-style: italic;"># fichier existe. Mais le comportement par défaut devrait être</span>
            <span style="color: #808080; font-style: italic;"># d'écraser le fichiers, sinon une personne qui ne lit pas le code</span>
            <span style="color: #808080; font-style: italic;"># source va croire que le code ne marche pas. De plus, il est plus</span>
            <span style="color: #808080; font-style: italic;"># rare de ne pas vouloir écraser les fichiers d'origine que</span>
            <span style="color: #808080; font-style: italic;"># l'inverse. Enfin, puisqu'on ne controle pas le nommage des fichiers</span>
            <span style="color: #808080; font-style: italic;"># depuis l'extérieur de la classe, il n'y a pas de moyen de réagir</span>
            <span style="color: #808080; font-style: italic;"># proprement pour dire &quot;je veux garder les anciens fichiers et</span>
            <span style="color: #808080; font-style: italic;"># avoir les nouveaux quand même&quot; à part utilise un dossier différent</span>
            <span style="color: #808080; font-style: italic;"># à chaque fois.</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> isfile<span style="color: black;">&#40;</span>filename<span style="color: black;">&#41;</span>:
&nbsp;
                <span style="color: #808080; font-style: italic;"># On récupère l'array de pixels en utilisant le code de la</span>
                <span style="color: #808080; font-style: italic;"># classe fille une fois de plus. C'est nécessaire puisque ça</span>
                <span style="color: #808080; font-style: italic;"># dépend de l'OS.</span>
                <span style="color: #808080; font-style: italic;"># Ce code ne fait pas du tout ce que vous croyez. get_pixels</span>
                <span style="color: #808080; font-style: italic;"># va sauvegarder l'image sans self.image, et retourner 1.</span>
                <span style="color: #808080; font-style: italic;"># C'est donc une fonction qui marche via ses effets de bords,</span>
                <span style="color: #808080; font-style: italic;"># ce qui est une très mauvaise pratique.</span>
                pixels <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">get_pixels</span><span style="color: black;">&#40;</span>monitor<span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #808080; font-style: italic;"># Même remarque que sur l'autre exception. De plus l'exception</span>
                <span style="color: #808080; font-style: italic;"># devrait être levée au niveau de get_pixels, pas au niveau</span>
                <span style="color: #808080; font-style: italic;"># de save(). Il y a un mélange de base niveau et de haut</span>
                <span style="color: #808080; font-style: italic;"># niveau dans cette classe qui rend l'API assez maladroite.</span>
                <span style="color: #808080; font-style: italic;"># D'ailleurs get_pixels ne retourne jamais None...</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> pixels <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
                    <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSS: no data to process.'</span><span style="color: black;">&#41;</span>
&nbsp;
                <span style="color: #808080; font-style: italic;"># Bon, ça c'est super crade. En gros il délègue le save à une</span>
                <span style="color: #808080; font-style: italic;"># méthode si elle existe, et sinon le fait à la main.</span>
                <span style="color: #808080; font-style: italic;"># L'héritage est fait pour ça, et il aurait été préférable</span>
                <span style="color: #808080; font-style: italic;"># de faire une méthode save(pixels, size, filename) générique</span>
                <span style="color: #808080; font-style: italic;"># et ensuite l'écraser dans les enfants. Peut être que c'est un</span>
                <span style="color: #808080; font-style: italic;"># dev C et qu'il n'est pas encore très à l'aise avec le POO.</span>
                <span style="color: #808080; font-style: italic;"># Il est possible que l'auteur ait rencontré des problèmes du</span>
                <span style="color: #808080; font-style: italic;"># fait d'une inconsistance d'api et n'ai pas su le gérer en</span>
                <span style="color: #808080; font-style: italic;"># mettant un adapter par dessus. Quand je vous dis que les</span>
                <span style="color: #808080; font-style: italic;"># design pattern c'est parfois utile :)</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">hasattr</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'save_'</span><span style="color: black;">&#41;</span>:
                    img_out <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">save_</span><span style="color: black;">&#40;</span>output<span style="color: #66cc66;">=</span>filename<span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">else</span>:
                    img <span style="color: #66cc66;">=</span> MSSImage<span style="color: black;">&#40;</span>pixels<span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'width'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'height'</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
                    img_out <span style="color: #66cc66;">=</span> img.<span style="color: black;">dump</span><span style="color: black;">&#40;</span>filename<span style="color: black;">&#41;</span>
                <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'save'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'img_out'</span><span style="color: #66cc66;">,</span> img_out<span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> img_out:
                    <span style="color: #808080; font-style: italic;"># Etant donné que la génération du screenshot prend du</span>
                    <span style="color: #808080; font-style: italic;"># temps et qu'il y en a plusieurs, l'auteur a intelligemment</span>
                    <span style="color: #808080; font-style: italic;"># choisit de faire un générateur, ce qui permet de ne pas</span>
                    <span style="color: #808080; font-style: italic;"># attendre que tous les screenshots soient terminé avant</span>
                    <span style="color: #808080; font-style: italic;"># de d'avoir un premier résultat.</span>
                    <span style="color: #ff7700;font-weight:bold;">yield</span> img_out
            <span style="color: #ff7700;font-weight:bold;">else</span>:
                <span style="color: #ff7700;font-weight:bold;">yield</span> filename + <span style="color: #483d8b;">' (already exists)'</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Les fameuses méthodes délégues aux classes filles. Un petit</span>
    <span style="color: #808080; font-style: italic;"># NotImplemented serait mieux que pass car c'est plus explicite, mais</span>
    <span style="color: #808080; font-style: italic;"># rien de grave.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> enum_display_monitors<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Get positions of all monitors.
&nbsp;
            If self.oneshot is True, this function has to return a dict
            with dimensions of all monitors at the same time.
            If the monitor has rotation, you have to deal with inside this method.
&nbsp;
            Must returns a dict with a minima:
            {
                'left':   the x-coordinate of the upper-left corner,
                'top':    the y-coordinate of the upper-left corner,
                'width':  the width,
                'height': the height
            }
        '''</span>
        <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> get_pixels<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> monitor_infos<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Retrieve screen pixels for a given monitor.
&nbsp;
            monitor_infos should contain at least:
            {
                'left':   the x-coordinate of the upper-left corner,
                'top':    the y-coordinate of the upper-left corner,
                'width':  the width,
                'heigth': the height
            }
&nbsp;
            Returns a dict with pixels.
        '''</span>
        <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Maintenant on par dans les détails de l'implémentation de l'algo qui récupère</span>
<span style="color: #808080; font-style: italic;"># les screenshots qui est spécifique à chaque OS.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> MSSMac<span style="color: black;">&#40;</span>MSS<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">''' Mutli-screen shot implementation for Mac OSX.
        It uses intensively the Quartz.
    '''</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Bon, du coup plutôt que de faire une fonction init, il aurait mieux</span>
    <span style="color: #808080; font-style: italic;"># valut faire une fonction __init__ qui appelle super().</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> init<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Mac OSX initialisations '''</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">pass</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Là c'est le gros du boulot, et c'est là que je vous dis que l'auteur</span>
    <span style="color: #808080; font-style: italic;"># c'est vraiment super cassé le cul pour trouver toutes ces infos sur</span>
    <span style="color: #808080; font-style: italic;"># les APIS propres à chaque système, et en plus en C. Kudos.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> enum_display_monitors<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Get positions of one or more monitors.
            Returns a dict with minimal requirements (see MSS class).
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'enum_display_monitors'</span><span style="color: black;">&#41;</span>
&nbsp;
        results <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #808080; font-style: italic;"># Si il y a un seul screen à prend, on se fait pas chier et on prend</span>
        <span style="color: #808080; font-style: italic;"># un rectangle de taille infinie pour les limites du screen. Je</span>
        <span style="color: #808080; font-style: italic;"># suppose que l'OS est capable de se démerder avec ça et borner</span>
        <span style="color: #808080; font-style: italic;"># à la taille du matos automatiquement. C'est un truc de faignasse, et</span>
        <span style="color: #808080; font-style: italic;"># c'est plutôt malin.</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span>:
            rect <span style="color: #66cc66;">=</span> CGRectInfinite
            results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                b<span style="color: #483d8b;">'left'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rect.<span style="color: black;">origin</span>.<span style="color: black;">x</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'top'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rect.<span style="color: black;">origin</span>.<span style="color: black;">y</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'width'</span> : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rect.<span style="color: black;">size</span>.<span style="color: black;">width</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'height'</span>: <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rect.<span style="color: black;">size</span>.<span style="color: black;">height</span><span style="color: black;">&#41;</span>
            <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            <span style="color: #808080; font-style: italic;"># Par contre là il faut se taper le calcul des coordonnées de</span>
            <span style="color: #808080; font-style: italic;"># rectangle à la main</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Cette variable est requise par CGGetActiveDisplayList mais</span>
            <span style="color: #808080; font-style: italic;"># comme le suggère le commentaire de l'auteur ci-dessous : LOL.</span>
            max_displays <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">32</span>  <span style="color: #808080; font-style: italic;"># Peut-être augmenté, si besoin...</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Apparemment il est possible que l'affichage ait subit une</span>
            <span style="color: #808080; font-style: italic;"># rotation. Je suppose que MacOS anticipait déjà l’existence des</span>
            <span style="color: #808080; font-style: italic;"># tablettes à l'époque.</span>
            rotations <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span><span style="color: #ff4500;">0.0</span>: <span style="color: #483d8b;">'normal'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">90.0</span>: <span style="color: #483d8b;">'right'</span><span style="color: #66cc66;">,</span> -<span style="color: #ff4500;">90.0</span>: <span style="color: #483d8b;">'left'</span><span style="color: black;">&#125;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># On demande les affichages qui sont effectivement en court</span>
            <span style="color: #808080; font-style: italic;"># d'utilisation, et on récupère un identifiant unique pour chacun</span>
            <span style="color: #808080; font-style: italic;"># d'entre deux.</span>
            res<span style="color: #66cc66;">,</span> ids<span style="color: #66cc66;">,</span> count <span style="color: #66cc66;">=</span> CGGetActiveDisplayList<span style="color: black;">&#40;</span>max_displays<span style="color: #66cc66;">,</span> <span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">None</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">for</span> display <span style="color: #ff7700;font-weight:bold;">in</span> ids:
                <span style="color: #808080; font-style: italic;"># On interroge l'API Mac pour avoir ses coordonnées, et on</span>
                <span style="color: #808080; font-style: italic;"># les extrait.</span>
                rect <span style="color: #66cc66;">=</span> CGRectStandardize<span style="color: black;">&#40;</span>CGDisplayBounds<span style="color: black;">&#40;</span>display<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
                left<span style="color: #66cc66;">,</span> top <span style="color: #66cc66;">=</span> rect.<span style="color: black;">origin</span>.<span style="color: black;">x</span><span style="color: #66cc66;">,</span> rect.<span style="color: black;">origin</span>.<span style="color: black;">y</span>
                width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> rect.<span style="color: black;">size</span>.<span style="color: black;">width</span><span style="color: #66cc66;">,</span> rect.<span style="color: black;">size</span>.<span style="color: black;">height</span>
                <span style="color: #808080; font-style: italic;"># Correction des coordonnées en cas de rotation.</span>
                rot <span style="color: #66cc66;">=</span> CGDisplayRotation<span style="color: black;">&#40;</span>display<span style="color: black;">&#41;</span>
                rotation <span style="color: #66cc66;">=</span> rotations<span style="color: black;">&#91;</span>rot<span style="color: black;">&#93;</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> rotation <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">'left'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'right'</span><span style="color: black;">&#93;</span>:
                    width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> height<span style="color: #66cc66;">,</span> width
&nbsp;
                <span style="color: #808080; font-style: italic;"># Et on insère le résultat dans la liste des monitors. On</span>
                <span style="color: #808080; font-style: italic;"># aurait pu yielder aussi comme dans save(), mais bon, c'est</span>
                <span style="color: #808080; font-style: italic;"># parce que je yield partout que je dis ça.</span>
                results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                    b<span style="color: #483d8b;">'left'</span>    : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>left<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                    b<span style="color: #483d8b;">'top'</span>     : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>top<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                    b<span style="color: #483d8b;">'width'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>width<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                    b<span style="color: #483d8b;">'height'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>height<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                    b<span style="color: #483d8b;">'rotation'</span>: rotation
                <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> results
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> get_pixels<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Retreive all pixels from a monitor. Pixels have to be RGB.
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère les coordonnées retournées par enum_display_monitors</span>
        <span style="color: #808080; font-style: italic;"># et on en fait un CGRect qui est nécessaire pour CGWindowListCreateImage.</span>
        width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'width'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'height'</span><span style="color: black;">&#93;</span>
        left<span style="color: #66cc66;">,</span> top <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'left'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'top'</span><span style="color: black;">&#93;</span>
        rect <span style="color: #66cc66;">=</span> CGRect<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>left<span style="color: #66cc66;">,</span> top<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: black;">&#40;</span>width<span style="color: #66cc66;">,</span> height<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># CGWindowListCreateImage retourne l'image à ces coordonnées.</span>
        <span style="color: #808080; font-style: italic;"># Les 3 derniers paramètres sont là grace à &quot;from Quartz import *&quot;</span>
        <span style="color: #808080; font-style: italic;"># (c'est pour ça que je vous dis de ne pas le faire, car c'est pas</span>
        <span style="color: #808080; font-style: italic;"># facile à retracer). kCGWindowListOptionOnScreenOnly force l'inclusion</span>
        <span style="color: #808080; font-style: italic;"># uniquement des fenêtre affichées et non celles hors écran.</span>
        <span style="color: #808080; font-style: italic;"># kCGNullWindowID est l'équivalent de None, dans ce contexte. C'est</span>
        <span style="color: #808080; font-style: italic;"># la fenêtre de référence, et on en veut aucune.</span>
        <span style="color: #808080; font-style: italic;"># kCGWindowImageDefault demande de capturer le fenêtre ET sa décoration</span>
        <span style="color: #808080; font-style: italic;"># (comme les ombres portées).</span>
        <span style="color: #808080; font-style: italic;"># Ces deux derniers params sont les valeurs par défaut donc je ne sais</span>
        <span style="color: #808080; font-style: italic;"># pas pourquoi il les passent.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">image</span> <span style="color: #66cc66;">=</span> CGWindowListCreateImage<span style="color: black;">&#40;</span>
                    rect<span style="color: #66cc66;">,</span> kCGWindowListOptionOnScreenOnly<span style="color: #66cc66;">,</span>
                    kCGNullWindowID<span style="color: #66cc66;">,</span> kCGWindowImageDefault<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Comme je le disais dans save(), la fonction ne retourne PAS l'objet</span>
        <span style="color: #808080; font-style: italic;"># image mais 1. L'image est stockée dans self.image et ce sont les</span>
        <span style="color: #808080; font-style: italic;"># autres méthodes qui tapent dans cet attribut. C'est mal.</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #ff4500;">1</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># la fameurse méthode save_ utilisée par save()...</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> save_<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> output<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Special method to not use MSSImage class. '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'save_'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># résolution du png</span>
        dpi <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">72</span>
        <span style="color: #808080; font-style: italic;"># chemin du png. Tout est URL dans Mac OS. Un chemin de fichier</span>
        <span style="color: #808080; font-style: italic;"># est une URL file://</span>
        url <span style="color: #66cc66;">=</span> NSURL.<span style="color: black;">fileURLWithPath_</span><span style="color: black;">&#40;</span>output<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On fabrique l'objet fichier</span>
        dest <span style="color: #66cc66;">=</span> CGImageDestinationCreateWithURL<span style="color: black;">&#40;</span>url<span style="color: #66cc66;">,</span> kUTTypePNG<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">None</span><span style="color: black;">&#41;</span>
        properties <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span>
            kCGImagePropertyDPIWidth: dpi<span style="color: #66cc66;">,</span>
            kCGImagePropertyDPIHeight: dpi<span style="color: #66cc66;">,</span>
        <span style="color: black;">&#125;</span>
        <span style="color: #808080; font-style: italic;"># On met notre image dans l'objet fichier. Là il faut se souvenir</span>
        <span style="color: #808080; font-style: italic;"># que save() appelle get_pixel() qui remplit self.image puis appelle</span>
        <span style="color: #808080; font-style: italic;"># save_() derrière. Je vous l'avais dis que les effets de bord, ça</span>
        <span style="color: #808080; font-style: italic;"># craint).</span>
        CGImageDestinationAddImage<span style="color: black;">&#40;</span>dest<span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">image</span><span style="color: #66cc66;">,</span> properties<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On écrit notre objet fichier sur le disk.</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> CGImageDestinationFinalize<span style="color: black;">&#40;</span>dest<span style="color: black;">&#41;</span>:
            output <span style="color: #66cc66;">=</span> <span style="color: #008000;">None</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># L'auteur vide ouput si CGImageDestinationFinalize à échoué. Il</span>
        <span style="color: #808080; font-style: italic;"># vaudrait mieux lever une exception.</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> output
&nbsp;
<span style="color: #808080; font-style: italic;"># On passe à l'implémentation Linux.</span>
<span style="color: #ff7700;font-weight:bold;">class</span> MSSLinux<span style="color: black;">&#40;</span>MSS<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">''' Mutli-screen shot implementation for GNU/Linux.
        It uses intensively the Xlib.
    '''</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Fait un travail de nettoyage quand l'objet est garbage collecté, en</span>
    <span style="color: #808080; font-style: italic;"># l'occurence ferme la connection avec le serveur x. Je rappelle que</span>
    <span style="color: #808080; font-style: italic;"># l'appel à __del__ n'est pas garanti donc mieux faut faire une méthode</span>
    <span style="color: #808080; font-style: italic;"># close() officielle et un context manager avec un finally.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__del__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Disconnect from X server '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'__del__'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">display</span>:
            <span style="color: #008000;">self</span>.<span style="color: black;">XCloseDisplay</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> init<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' GNU/Linux initialisations '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># on charge la shared lib du serveur x</span>
        x11 <span style="color: #66cc66;">=</span> find_library<span style="color: black;">&#40;</span><span style="color: #483d8b;">'X11'</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> x11 <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">OSError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSSLinux: no X11 library found.'</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            xlib <span style="color: #66cc66;">=</span> cdll.<span style="color: black;">LoadLibrary</span><span style="color: black;">&#40;</span>x11<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'xlib'</span><span style="color: #66cc66;">,</span> xlib<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Aliasing des méthode de xlib. Pourquoi ? Aucune idée.</span>
        <span style="color: #808080; font-style: italic;"># passer l'objet xlib le parait plus logique. Peut être qu'il y a</span>
        <span style="color: #808080; font-style: italic;"># une raison technique liée au mapping ctypes, mais je ne la connais</span>
        <span style="color: #808080; font-style: italic;"># pas.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XOpenDisplay</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XOpenDisplay</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultScreen</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XDefaultScreen</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultRootWindow</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XDefaultRootWindow</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetWindowAttributes</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XGetWindowAttributes</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XAllPlanes</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XAllPlanes</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetImage</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XGetImage</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetPixel</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XGetPixel</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XFree</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XFree</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XCloseDisplay</span> <span style="color: #66cc66;">=</span> xlib.<span style="color: black;">XCloseDisplay</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># ctypes permet de spécifier pour chaque fonction des types attendus</span>
        <span style="color: #808080; font-style: italic;"># en paramètre et en valeur de retour. Cela permet l'autocasting</span>
        <span style="color: #808080; font-style: italic;"># de types compatibles et une exception explicite en cas de passage</span>
        <span style="color: #808080; font-style: italic;"># de mauvais paramètres plutôt qu'un core dump.</span>
        <span style="color: #808080; font-style: italic;"># L'auteur ici à mis ce code un peu lourd dans des méthodes dédiées et</span>
        <span style="color: #808080; font-style: italic;"># préfixées de _ puisqu'à usage interne.</span>
        <span style="color: #008000;">self</span>._set_argtypes<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>._set_restypes<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère l'affichage en cours en tapant dans les variables</span>
        <span style="color: #808080; font-style: italic;"># d'environnement. Le jobby-jobba et du au fait qu'il veut garder</span>
        <span style="color: #808080; font-style: italic;"># la compatibilité Python 3 et 2.7 et qu'il faut accomoder</span>
        <span style="color: #808080; font-style: italic;"># les types str/unicode/bytes.</span>
        <span style="color: #808080; font-style: italic;"># C'est une vérification pour éviter un segfault si il n'y pas de</span>
        <span style="color: #808080; font-style: italic;"># serveur x qui tourne.</span>
        display <span style="color: #66cc66;">=</span> <span style="color: #008000;">None</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">display</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">None</span>
        <span style="color: #ff7700;font-weight:bold;">try</span>:
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #dc143c;">sys</span>.<span style="color: black;">version</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #483d8b;">'3'</span>:
                display <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">bytes</span><span style="color: black;">&#40;</span>environ<span style="color: black;">&#91;</span><span style="color: #483d8b;">'DISPLAY'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'utf-8'</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">else</span>:
                display <span style="color: #66cc66;">=</span> environ<span style="color: black;">&#91;</span><span style="color: #483d8b;">'DISPLAY'</span><span style="color: black;">&#93;</span>
        <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
            err <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'MSSLinux: $DISPLAY not set. Stopping to prevent segfault.'</span>
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span>err<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'$DISPLAY'</span><span style="color: #66cc66;">,</span> display<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère l'écran par défaut et la fenêtre racine sur l'affichage</span>
        <span style="color: #808080; font-style: italic;"># en cours.</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># At this point, if there is no running server, it could end on</span>
        <span style="color: #808080; font-style: italic;"># a segmentation fault. And we cannot catch it.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">display</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XOpenDisplay</span><span style="color: black;">&#40;</span>display<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'display'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">screen</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultScreen</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'screen'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">screen</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">root</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultRootWindow</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">screen</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'root'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">root</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># les deux méthodes qui servent à manuellement définir les types</span>
    <span style="color: #808080; font-style: italic;"># des autres méthodes dont j'ai parlé plus haut.</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> _set_argtypes<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Functions arguments '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'_set_argtypes'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">XOpenDisplay</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>c_char_p<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultScreen</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultRootWindow</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetWindowAttributes</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            POINTER<span style="color: black;">&#40;</span>XWindowAttributes<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> POINTER<span style="color: black;">&#40;</span>XWindowAttributes<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XAllPlanes</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetImage</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            c_int<span style="color: #66cc66;">,</span> c_int<span style="color: #66cc66;">,</span> c_uint<span style="color: #66cc66;">,</span> c_uint<span style="color: #66cc66;">,</span> c_ulong<span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetPixel</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>XImage<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> c_int<span style="color: #66cc66;">,</span> c_int<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XFree</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>XImage<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XCloseDisplay</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> _set_restypes<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Functions return type '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'_set_restypes'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">XOpenDisplay</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultScreen</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_int
        <span style="color: #008000;">self</span>.<span style="color: black;">XDefaultRootWindow</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> POINTER<span style="color: black;">&#40;</span>XWindowAttributes<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetWindowAttributes</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_int
        <span style="color: #008000;">self</span>.<span style="color: black;">XAllPlanes</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_ulong
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetImage</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> POINTER<span style="color: black;">&#40;</span>XImage<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XGetPixel</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_ulong
        <span style="color: #008000;">self</span>.<span style="color: black;">XFree</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_void_p
        <span style="color: #008000;">self</span>.<span style="color: black;">XCloseDisplay</span>.<span style="color: black;">restype</span> <span style="color: #66cc66;">=</span> c_void_p
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> enum_display_monitors<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Get positions of one or more monitors.
            Returns a dict with minimal requirements (see MSS class).
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'enum_display_monitors'</span><span style="color: black;">&#41;</span>
&nbsp;
        results <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span>:
            <span style="color: #808080; font-style: italic;"># Dans le cas d'un seul screenshot pour tout, on récupère juste</span>
            <span style="color: #808080; font-style: italic;"># les coordonnées de la fenêtre racine.</span>
            gwa <span style="color: #66cc66;">=</span> XWindowAttributes<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">XGetWindowAttributes</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">root</span><span style="color: #66cc66;">,</span> byref<span style="color: black;">&#40;</span>gwa<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                b<span style="color: #483d8b;">'left'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>gwa.<span style="color: black;">x</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'top'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>gwa.<span style="color: black;">y</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'width'</span> : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>gwa.<span style="color: black;">width</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'height'</span>: <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>gwa.<span style="color: black;">height</span><span style="color: black;">&#41;</span>
            <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
&nbsp;
            <span style="color: #808080; font-style: italic;"># Sinon on parse le fichier XML de config pour essayer de</span>
            <span style="color: #808080; font-style: italic;"># trouver les coordonnées. Je ne suis pas certain que ce soit</span>
            <span style="color: #808080; font-style: italic;"># une bonne stratégie puisque le fichier monitors.xml contient</span>
            <span style="color: #808080; font-style: italic;"># tous les moniteurs jamais branché sur la machine, y compris ceux</span>
            <span style="color: #808080; font-style: italic;"># qu'on a pas branché depuis 1000 ans...</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># It is a little more complicated, we have to guess all stuff</span>
            <span style="color: #808080; font-style: italic;"># from ~/.config/monitors.xml, if present.</span>
            monitors <span style="color: #66cc66;">=</span> expanduser<span style="color: black;">&#40;</span><span style="color: #483d8b;">'~/.config/monitors.xml'</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> isfile<span style="color: black;">&#40;</span>monitors<span style="color: black;">&#41;</span>:
                <span style="color: #808080; font-style: italic;"># Ici, lever une exception serait pas mal.</span>
                <span style="color: #808080; font-style: italic;"># A la place, l'auteur choisit de mettre oneshot et de relancer</span>
                <span style="color: #808080; font-style: italic;"># la capture. Donc au lieu d'avoir ce qu'on demande ou une</span>
                <span style="color: #808080; font-style: italic;"># erreur, on a ce qu'on demande ou ce qu'on ne demande pas.</span>
                <span style="color: #808080; font-style: italic;"># Encore une fois, j'en profite pour souligner qu'il faut</span>
                <span style="color: #808080; font-style: italic;"># éviter ce genre de config à base de site effects. Devoir</span>
                <span style="color: #808080; font-style: italic;"># setter un attribut pour avoir un résultat différent à cette</span>
                <span style="color: #808080; font-style: italic;"># méthode n'est pas très propre.</span>
                <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'ERROR'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'MSSLinux: enum_display_monitors() failed (no monitors.xml).'</span><span style="color: black;">&#41;</span>
                <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">True</span>
                <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">enum_display_monitors</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Le XML est une collection de noeuds 'configuration' qui représentent</span>
            <span style="color: #808080; font-style: italic;"># chacun un moniteur. On récupère ici le premier noeud 'configurations'</span>
            tree <span style="color: #66cc66;">=</span> ET.<span style="color: black;">parse</span><span style="color: black;">&#40;</span>monitors<span style="color: black;">&#41;</span>
            root <span style="color: #66cc66;">=</span> tree.<span style="color: black;">getroot</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
            config <span style="color: #66cc66;">=</span> root.<span style="color: black;">findall</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'configuration'</span><span style="color: black;">&#41;</span><span style="color: black;">&#91;</span>-<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span>
            conf <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
            <span style="color: #808080; font-style: italic;"># chaque noeud &quot;configurations&quot; à une série de noeuds ouput qui</span>
            <span style="color: #808080; font-style: italic;"># représentent chaque format de sortie (VGA, HDMI, etc). On</span>
            <span style="color: #808080; font-style: italic;"># boucle dessus.</span>
            <span style="color: #ff7700;font-weight:bold;">for</span> output <span style="color: #ff7700;font-weight:bold;">in</span> config.<span style="color: black;">findall</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'output'</span><span style="color: black;">&#41;</span>:
                name <span style="color: #66cc66;">=</span> output.<span style="color: black;">get</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'name'</span><span style="color: black;">&#41;</span>
                <span style="color: #ff7700;font-weight:bold;">if</span> name <span style="color: #66cc66;">!=</span> <span style="color: #483d8b;">'default'</span>:
                    <span style="color: #808080; font-style: italic;"># On récupère les coordonnées, la rotation, on extrait,</span>
                    <span style="color: #808080; font-style: italic;"># on corrige, on ajoute à la liste... Bref, même topo</span>
                    <span style="color: #808080; font-style: italic;"># qu'avec MacOsX.</span>
                    x <span style="color: #66cc66;">=</span> output.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'x'</span><span style="color: black;">&#41;</span>
                    y <span style="color: #66cc66;">=</span> output.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'y'</span><span style="color: black;">&#41;</span>
                    width <span style="color: #66cc66;">=</span> output.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'width'</span><span style="color: black;">&#41;</span>
                    height <span style="color: #66cc66;">=</span> output.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'height'</span><span style="color: black;">&#41;</span>
                    rotation <span style="color: #66cc66;">=</span> output.<span style="color: black;">find</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'rotation'</span><span style="color: black;">&#41;</span>
                    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">None</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span>x<span style="color: #66cc66;">,</span> y<span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">,</span> height<span style="color: black;">&#93;</span> <span style="color: #ff7700;font-weight:bold;">and</span> name <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #ff7700;font-weight:bold;">in</span> conf:
                        conf.<span style="color: black;">append</span><span style="color: black;">&#40;</span>name<span style="color: black;">&#41;</span>
                        <span style="color: #ff7700;font-weight:bold;">if</span> rotation.<span style="color: black;">text</span> <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: black;">&#91;</span><span style="color: #483d8b;">'left'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'right'</span><span style="color: black;">&#93;</span>:
                            width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> height<span style="color: #66cc66;">,</span> width
                        results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                            b<span style="color: #483d8b;">'left'</span>    : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>x.<span style="color: black;">text</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                            b<span style="color: #483d8b;">'top'</span>     : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>y.<span style="color: black;">text</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                            b<span style="color: #483d8b;">'width'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>width.<span style="color: black;">text</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                            b<span style="color: #483d8b;">'height'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>height.<span style="color: black;">text</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                            b<span style="color: #483d8b;">'rotation'</span>: rotation.<span style="color: black;">text</span>
                        <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> results
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> get_pixels<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Retreive all pixels from a monitor. Pixels have to be RGB.
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère les coordonnées des monitors revoyées par enum_display_monitors</span>
        width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'width'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'height'</span><span style="color: black;">&#93;</span>
        left<span style="color: #66cc66;">,</span> top <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'left'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'top'</span><span style="color: black;">&#93;</span>
        ZPixmap <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">2</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère un masque de pixels pour l'ensemble de l'affichage</span>
        allplanes <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XAllPlanes</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'allplanes'</span><span style="color: #66cc66;">,</span> allplanes<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Visiblement un fix. C'est ce qu'on appelle un commentaire utile.</span>
        <span style="color: #808080; font-style: italic;"># Fix for XGetImage: expected LP_Display instance instead of LP_XWindowAttributes</span>
        root <span style="color: #66cc66;">=</span> cast<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">root</span><span style="color: #66cc66;">,</span> POINTER<span style="color: black;">&#40;</span>Display<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On récupère un dump des pixels pour les coordonnées en cours, de</span>
        <span style="color: #808080; font-style: italic;"># l'affichage en cours, on lui applique le masque de pixel mais</span>
        <span style="color: #808080; font-style: italic;"># je ne sais pas pourquoi on doit le faire. x11 est une bestiole</span>
        <span style="color: #808080; font-style: italic;"># très tarabiscotée, et mes recherches n'ont rien donné. L'auteur</span>
        <span style="color: #808080; font-style: italic;"># a du bien s'amuser à trouver comment faire ce genre de chose.</span>
        image <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XGetImage</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">display</span><span style="color: #66cc66;">,</span> root<span style="color: #66cc66;">,</span> left<span style="color: #66cc66;">,</span> top<span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">,</span>
            height<span style="color: #66cc66;">,</span> allplanes<span style="color: #66cc66;">,</span> ZPixmap<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> image <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSSLinux: XGetImage() failed.'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Les pixels doivent être récupérés en RGB. L'auteur fait donc une</span>
        <span style="color: #808080; font-style: italic;"># fonction de conversion (c'est une fonction inline, donc jetable)</span>
        <span style="color: #808080; font-style: italic;"># puis l'applique à la liste des pixels qu'il récupère dans l'image.</span>
        <span style="color: #808080; font-style: italic;"># Une simple boucle for aurait fait l'affaire mais l'auteur a mis</span>
        <span style="color: #808080; font-style: italic;"># en place une stratégie de mémoisation (mise en cache) dans la fonction.</span>
        <span style="color: #808080; font-style: italic;"># Vu que la fonction est inline, un simple dico aurait aussi fait</span>
        <span style="color: #808080; font-style: italic;"># l'affaire. Mais une il est très possible qu'on lui ait donné</span>
        <span style="color: #808080; font-style: italic;"># le truc et comme il n'est pas habitué à Python il a juste copié/collé.</span>
        <span style="color: #808080; font-style: italic;"># Je le fais souvent en Java / C donc je vais pas lui jeter la pierre.</span>
        <span style="color: #ff7700;font-weight:bold;">def</span> pix<span style="color: black;">&#40;</span>pixel<span style="color: #66cc66;">,</span> _resultats<span style="color: #66cc66;">=</span><span style="color: black;">&#123;</span><span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>:
            <span style="color: #483d8b;">''' Apply shifts to a pixel to get the RGB values.
                This method uses of memoization.
            '''</span>
            <span style="color: #808080; font-style: italic;"># La mise en cache se fait à ce niveau.</span>
            <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> pixel <span style="color: #ff7700;font-weight:bold;">in</span> _resultats:
                <span style="color: #808080; font-style: italic;"># Là c'est du byte shifting, mais quelle logique exacte est</span>
                <span style="color: #808080; font-style: italic;"># implémentée, aucune idée. Il faudrait regarder les algos</span>
                <span style="color: #808080; font-style: italic;"># de conversion pixels vers RGB et trouver celui qui est</span>
                <span style="color: #808080; font-style: italic;"># appliqué. C'est le genre de truc que je copie/colle car</span>
                <span style="color: #808080; font-style: italic;"># je suis trop feignant et tester que ça marche est plus rapide</span>
                <span style="color: #808080; font-style: italic;"># que comprendre.</span>
                _resultats<span style="color: black;">&#91;</span>pixel<span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> b<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>pixel &amp; <span style="color: #ff4500;">16711680</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&gt;&gt;</span> <span style="color: #ff4500;">16</span><span style="color: black;">&#41;</span> + b<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>pixel &amp; <span style="color: #ff4500;">65280</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">&gt;&gt;</span> <span style="color: #ff4500;">8</span><span style="color: black;">&#41;</span> + b<span style="color: black;">&#40;</span>pixel &amp; <span style="color: #ff4500;">255</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">return</span> _resultats<span style="color: black;">&#91;</span>pixel<span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Aliasing de la fonction pour gagner en vitesse en évitant un lookup</span>
        <span style="color: #808080; font-style: italic;"># d'attribut dans une boucle.</span>
        get_pix <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">XGetPixel</span>
        <span style="color: #808080; font-style: italic;"># Boucle de conversion via une liste en intention.</span>
        pixels <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>pix<span style="color: black;">&#40;</span>get_pix<span style="color: black;">&#40;</span>image<span style="color: #66cc66;">,</span> x<span style="color: #66cc66;">,</span> y<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> y <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span>height<span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span>width<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Ici get_pixels retourne l'objet image plutôt que de la sauver</span>
        <span style="color: #808080; font-style: italic;"># dans un attribut self.image. Ouch.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">XFree</span><span style="color: black;">&#40;</span>image<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>pixels<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># On passe maintenant à l'implémentation pour Windows</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> MSSWindows<span style="color: black;">&#40;</span>MSS<span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">''' Mutli-screen shot implementation for Microsoft Windows. '''</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Même topo que pour la version Linux. Même principe que son init.</span>
    <span style="color: #ff7700;font-weight:bold;">def</span> init<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Windows initialisations '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'init'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">user32</span>.<span style="color: black;">GetSystemMetrics</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">EnumDisplayMonitors</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">user32</span>.<span style="color: black;">EnumDisplayMonitors</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">GetWindowDC</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">user32</span>.<span style="color: black;">GetWindowDC</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleDC</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">CreateCompatibleDC</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleBitmap</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">CreateCompatibleBitmap</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">SelectObject</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">SelectObject</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">BitBlt</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">BitBlt</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">GetDIBits</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">GetDIBits</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span> <span style="color: #66cc66;">=</span> windll.<span style="color: black;">gdi32</span>.<span style="color: black;">DeleteObject</span>
&nbsp;
        <span style="color: #008000;">self</span>._set_argtypes<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>._set_restypes<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> _set_argtypes<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Functions arguments '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'_set_argtypes'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">MONITORENUMPROC</span> <span style="color: #66cc66;">=</span> WINFUNCTYPE<span style="color: black;">&#40;</span>INT<span style="color: #66cc66;">,</span> DWORD<span style="color: #66cc66;">,</span> DWORD<span style="color: #66cc66;">,</span>
            POINTER<span style="color: black;">&#40;</span>RECT<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> DOUBLE<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>INT<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">EnumDisplayMonitors</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: #66cc66;">,</span> LPRECT<span style="color: #66cc66;">,</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">MONITORENUMPROC</span><span style="color: #66cc66;">,</span> LPARAM<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">GetWindowDC</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HWND<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleDC</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleBitmap</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> INT<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">SelectObject</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: #66cc66;">,</span> HGDIOBJ<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">BitBlt</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> HDC<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> INT<span style="color: #66cc66;">,</span> DWORD<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HGDIOBJ<span style="color: black;">&#93;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">GetDIBits</span>.<span style="color: black;">argtypes</span> <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>HDC<span style="color: #66cc66;">,</span> HBITMAP<span style="color: #66cc66;">,</span> UINT<span style="color: #66cc66;">,</span> UINT<span style="color: #66cc66;">,</span> LPVOID<span style="color: #66cc66;">,</span>
            POINTER<span style="color: black;">&#40;</span>BITMAPINFO<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> UINT<span style="color: black;">&#93;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> _set_restypes<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Functions return type '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'_set_restypes'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> INT
        <span style="color: #008000;">self</span>.<span style="color: black;">EnumDisplayMonitors</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> BOOL
        <span style="color: #008000;">self</span>.<span style="color: black;">GetWindowDC</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> HDC
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleDC</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> HDC
        <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleBitmap</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> HBITMAP
        <span style="color: #008000;">self</span>.<span style="color: black;">SelectObject</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> HGDIOBJ
        <span style="color: #008000;">self</span>.<span style="color: black;">BitBlt</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span>  BOOL
        <span style="color: #008000;">self</span>.<span style="color: black;">GetDIBits</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> INT
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span>.<span style="color: black;">restypes</span> <span style="color: #66cc66;">=</span> BOOL
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> enum_display_monitors<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Get positions of one or more monitors.
            Returns a dict with minimal requirements (see MSS class).
        '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'enum_display_monitors'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># le code qui permet de récupérer les moniteurs est visiblement</span>
        <span style="color: #808080; font-style: italic;"># asynchrone, donc on fabrique un callback qui va remplir le tableau</span>
        <span style="color: #808080; font-style: italic;"># des résultats.</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">def</span> _callback<span style="color: black;">&#40;</span>monitor<span style="color: #66cc66;">,</span> dc<span style="color: #66cc66;">,</span> rect<span style="color: #66cc66;">,</span> data<span style="color: black;">&#41;</span>:
            rct <span style="color: #66cc66;">=</span> rect.<span style="color: black;">contents</span>
            results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                b<span style="color: #483d8b;">'left'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rct.<span style="color: black;">left</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'top'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rct.<span style="color: black;">top</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'width'</span> : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rct.<span style="color: black;">right</span> - rct.<span style="color: black;">left</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'height'</span>: <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>rct.<span style="color: black;">bottom</span> -rct.<span style="color: black;">top</span><span style="color: black;">&#41;</span>
            <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #ff4500;">1</span>
&nbsp;
        results <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span><span style="color: black;">&#93;</span>
        <span style="color: #808080; font-style: italic;"># si c'est juste un seul screenshot, c'est un appel synchrone</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">oneshot</span>:
            <span style="color: #808080; font-style: italic;"># ce sont des constantes qui déterminent quelle info ont veut que</span>
            <span style="color: #808080; font-style: italic;"># GetSystemMetrics renvoit. Ici on demande les coordonnées de tout</span>
            <span style="color: #808080; font-style: italic;"># l'écran, une par une.</span>
            SM_XVIRTUALSCREEN <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">76</span>
            SM_YVIRTUALSCREEN <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">77</span>
            SM_CXVIRTUALSCREEN <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">78</span>
            SM_CYVIRTUALSCREEN <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">79</span>
            left <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span><span style="color: black;">&#40;</span>SM_XVIRTUALSCREEN<span style="color: black;">&#41;</span>
            right <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span><span style="color: black;">&#40;</span>SM_CXVIRTUALSCREEN<span style="color: black;">&#41;</span>
            top <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span><span style="color: black;">&#40;</span>SM_YVIRTUALSCREEN<span style="color: black;">&#41;</span>
            bottom <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetSystemMetrics</span><span style="color: black;">&#40;</span>SM_CYVIRTUALSCREEN<span style="color: black;">&#41;</span>
            results.<span style="color: black;">append</span><span style="color: black;">&#40;</span><span style="color: black;">&#123;</span>
                b<span style="color: #483d8b;">'left'</span>  : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>left<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'top'</span>   : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>top<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'width'</span> : <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>right - left<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
                b<span style="color: #483d8b;">'height'</span>: <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>bottom - top<span style="color: black;">&#41;</span>
            <span style="color: black;">&#125;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">else</span>:
            <span style="color: #808080; font-style: italic;"># On enrobe le callback Python dans un proxy qui le rend</span>
            <span style="color: #808080; font-style: italic;"># utilisable par le code C</span>
            callback <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">MONITORENUMPROC</span><span style="color: black;">&#40;</span>_callback<span style="color: black;">&#41;</span>
            <span style="color: #808080; font-style: italic;"># On demande à windows de nous lister les moniteurs, et comme</span>
            <span style="color: #808080; font-style: italic;"># cet appel est asynchrone, on lui passe un callback pour qu'il</span>
            <span style="color: #808080; font-style: italic;"># replisse la liste au fur et à mesure</span>
            <span style="color: #008000;">self</span>.<span style="color: black;">EnumDisplayMonitors</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> callback<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On retourne la liste. A ce stade là, on ne sait pas si la liste</span>
        <span style="color: #808080; font-style: italic;"># est vide, à moitié remplie ou complètement remplie. Utiliser du</span>
        <span style="color: #808080; font-style: italic;"># code asynchrone au milieu d'une lib synchrone, c'est assez dangereux</span>
        <span style="color: #808080; font-style: italic;"># donc je me demande comment il retombe sur ses pieds.</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> results
&nbsp;
    <span style="color: #808080; font-style: italic;"># A ce stade là il est 13h, j'ai commencé à 9h et j'ai la dalle. J'en ai</span>
    <span style="color: #808080; font-style: italic;"># marre de commenter ce code. 'envoyez-vous les codes que vous pigez pas'</span>
    <span style="color: #808080; font-style: italic;"># est une idée à la con. Je vous hais tous. Mon coloc va me ramener des</span>
    <span style="color: #808080; font-style: italic;"># frites.</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> get_pixels<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Retreive all pixels from a monitor. Pixels have to be RGB. '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Encore une fois on récupère les coordonnées des moniteurs filées</span>
        <span style="color: #808080; font-style: italic;"># par enum_display_monitors</span>
        width<span style="color: #66cc66;">,</span> height <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'width'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'height'</span><span style="color: black;">&#93;</span>
        left<span style="color: #66cc66;">,</span> top <span style="color: #66cc66;">=</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'left'</span><span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> monitor<span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'top'</span><span style="color: black;">&#93;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Reajustement de la taille de la largeur. Je suppose que c'est</span>
        <span style="color: #808080; font-style: italic;"># empirique, mais je peux me tromper.</span>
        good_width <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span>width * <span style="color: #ff4500;">3</span> + <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span> &amp; -<span style="color: #ff4500;">4</span>
        <span style="color: #808080; font-style: italic;"># Valeur de paramètre qui dit de copier directement dans le rectangle</span>
        <span style="color: #808080; font-style: italic;"># des destination.</span>
        SRCCOPY <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">0xCC0020</span>
        DIB_RGB_COLORS <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">0</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Récupère le Device Context (title bar, menus, and scroll bars, etc)</span>
        srcdc <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetWindowDC</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On fabrique une copie en mémoire.</span>
        memdc <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleDC</span><span style="color: black;">&#40;</span>srcdc<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On fabrique un bitmap basé sur ce DC</span>
        bmp <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">CreateCompatibleBitmap</span><span style="color: black;">&#40;</span>srcdc<span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">,</span> height<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On injecte un bitmap dans le DC en mémoire.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">SelectObject</span><span style="color: black;">&#40;</span>memdc<span style="color: #66cc66;">,</span> bmp<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On transfert les bits d'un DC à l'autre.</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">BitBlt</span><span style="color: black;">&#40;</span>memdc<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">,</span> height<span style="color: #66cc66;">,</span> srcdc<span style="color: #66cc66;">,</span> left<span style="color: #66cc66;">,</span> top<span style="color: #66cc66;">,</span> SRCCOPY<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On fabrique le header du BMP</span>
        bmi <span style="color: #66cc66;">=</span> BITMAPINFO<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>
        bmi.<span style="color: black;">bmiHeader</span>.<span style="color: black;">biSize</span> <span style="color: #66cc66;">=</span> sizeof<span style="color: black;">&#40;</span>BITMAPINFOHEADER<span style="color: black;">&#41;</span>
        bmi.<span style="color: black;">bmiHeader</span>.<span style="color: black;">biWidth</span> <span style="color: #66cc66;">=</span> width
        bmi.<span style="color: black;">bmiHeader</span>.<span style="color: black;">biHeight</span> <span style="color: #66cc66;">=</span> height
        bmi.<span style="color: black;">bmiHeader</span>.<span style="color: black;">biBitCount</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">24</span>
        bmi.<span style="color: black;">bmiHeader</span>.<span style="color: black;">biPlanes</span> <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">1</span>
        buffer_len <span style="color: #66cc66;">=</span> height * good_width
        <span style="color: #808080; font-style: italic;"># On fabrique un array de char</span>
        pixels <span style="color: #66cc66;">=</span> create_string_buffer<span style="color: black;">&#40;</span>buffer_len<span style="color: black;">&#41;</span>
        <span style="color: #808080; font-style: italic;"># On récupère les bits du bitmap issu du DC</span>
        bits <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">GetDIBits</span><span style="color: black;">&#40;</span>memdc<span style="color: #66cc66;">,</span> bmp<span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> height<span style="color: #66cc66;">,</span> byref<span style="color: black;">&#40;</span>pixels<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span>
            pointer<span style="color: black;">&#40;</span>bmi<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> DIB_RGB_COLORS<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'srcdc'</span><span style="color: #66cc66;">,</span> srcdc<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'memdc'</span><span style="color: #66cc66;">,</span> memdc<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'bmp'</span><span style="color: #66cc66;">,</span> bmp<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'buffer_len'</span><span style="color: #66cc66;">,</span> buffer_len<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'bits'</span><span style="color: #66cc66;">,</span> bits<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'get_pixels'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'len(pixels.raw)'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>pixels.<span style="color: black;">raw</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Nettoyage des objets.</span>
        <span style="color: #808080; font-style: italic;"># Clean up</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span><span style="color: black;">&#40;</span>srcdc<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span><span style="color: black;">&#40;</span>memdc<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">DeleteObject</span><span style="color: black;">&#40;</span>bmp<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Apparemment la récupération peut échouer et on peut vérifier</span>
        <span style="color: #808080; font-style: italic;"># cet échec en checkant la longueur. Après la cause de l'échec est</span>
        <span style="color: #808080; font-style: italic;"># un mystère</span>
        <span style="color: #ff7700;font-weight:bold;">if</span> bits <span style="color: #66cc66;">!=</span> height <span style="color: #ff7700;font-weight:bold;">or</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>pixels.<span style="color: black;">raw</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">!=</span> buffer_len:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSSWindows: GetDIBits() failed.'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Réorganise les bits dans le bonne ordre et converti le format</span>
        <span style="color: #808080; font-style: italic;"># de couleur de BGR vers RGB</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># Note that the origin of the returned image is in the</span>
        <span style="color: #808080; font-style: italic;"># bottom-left corner, 32-bit aligned. And it is BGR.</span>
        <span style="color: #808080; font-style: italic;"># Need to &quot;arrange&quot; that.</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>._arrange<span style="color: black;">&#40;</span>pixels.<span style="color: black;">raw</span><span style="color: #66cc66;">,</span> good_width<span style="color: #66cc66;">,</span> height<span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> _arrange<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> data<span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">,</span> height<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Reorganises data when the origin of the image is in the
            bottom-left corner and converts BGR triple to RGB. '''</span>
&nbsp;
        <span style="color: #008000;">self</span>.<span style="color: black;">debug</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'_arrange'</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On crée une nouvelle liste pleine de zéro, et on la rempli</span>
        <span style="color: #808080; font-style: italic;"># avec la nouvelle position des pixels.</span>
        total <span style="color: #66cc66;">=</span> width * height
        scanlines <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'0'</span><span style="color: black;">&#93;</span> * total
        <span style="color: #ff7700;font-weight:bold;">for</span> y <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span>height<span style="color: black;">&#41;</span>:
            off <span style="color: #66cc66;">=</span> width * <span style="color: black;">&#40;</span>y + <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>
            offset <span style="color: #66cc66;">=</span> total - off
            <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span><span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> width - <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span>:
                <span style="color: #808080; font-style: italic;"># On inverse aussi la position du bleu et du rouge</span>
                scanlines<span style="color: black;">&#91;</span>off+x:off+x+<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> b<span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>offset+x+<span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> b<span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>offset+x+<span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> b<span style="color: black;">&#40;</span>data<span style="color: black;">&#91;</span>offset+x<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">return</span> b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>scanlines<span style="color: black;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Un wrapper pour dumper un array de pixels dans un fichier</span>
<span style="color: #808080; font-style: italic;"># Typiquement un truc qui aurait pu tenir dans une fonction au lieu d'une classe.</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">class</span> MSSImage<span style="color: black;">&#40;</span><span style="color: #008000;">object</span><span style="color: black;">&#41;</span>:
    <span style="color: #483d8b;">''' This is a class to save data (raw pixels) to a picture file.
    '''</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__init__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> data<span style="color: #66cc66;">=</span><span style="color: #008000;">None</span><span style="color: #66cc66;">,</span> width<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: #66cc66;">,</span> height<span style="color: #66cc66;">=</span><span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span>:
        <span style="color: #008000;">self</span>.<span style="color: black;">data</span> <span style="color: #66cc66;">=</span> data
        <span style="color: #008000;">self</span>.<span style="color: black;">width</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>width<span style="color: black;">&#41;</span>
        <span style="color: #008000;">self</span>.<span style="color: black;">height</span> <span style="color: #66cc66;">=</span> <span style="color: #008000;">int</span><span style="color: black;">&#40;</span>height<span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">self</span>.<span style="color: black;">data</span> <span style="color: #ff7700;font-weight:bold;">is</span> <span style="color: #008000;">None</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSSImage: no data to process.'</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #008000;">self</span>.<span style="color: black;">width</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #ff4500;">1</span> <span style="color: #ff7700;font-weight:bold;">or</span> <span style="color: #008000;">self</span>.<span style="color: black;">height</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #ff4500;">1</span>:
            <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">ValueError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'MSSImage: width or height must be positive.'</span><span style="color: black;">&#41;</span>
&nbsp;
&nbsp;
    <span style="color: #808080; font-style: italic;"># Tout le boulot se passe ici.</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">def</span> dump<span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: #66cc66;">,</span> output<span style="color: black;">&#41;</span>:
        <span style="color: #483d8b;">''' Dump data to the image file.
            Pure python PNG implementation.
            Image represented as RGB tuples, no interlacing.
            http://inaps.org/journal/comment-fonctionne-le-png
        '''</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># On ouvre le fichier en mode écriture binaire.</span>
&nbsp;
        <span style="color: #ff7700;font-weight:bold;">with</span> <span style="color: #008000;">open</span><span style="color: black;">&#40;</span>output<span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'wb'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">as</span> fileh:
            <span style="color: #808080; font-style: italic;"># Pour cette partie il faut connaitre les subtilités du format PNG</span>
            <span style="color: #808080; font-style: italic;"># pour comprendre, ce qui n'est pas mon cas. Donc je vais faire</span>
            <span style="color: #808080; font-style: italic;"># de la déduction au gros doigt mouillé.</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Ca prend les données en pixel, ça en fait des morceaux de la bonne taille,</span>
            <span style="color: #808080; font-style: italic;"># organisés en rangés de pixels puisqu'il y a range(height) rangés.</span>
            to_take <span style="color: #66cc66;">=</span> <span style="color: black;">&#40;</span><span style="color: #008000;">self</span>.<span style="color: black;">width</span> * <span style="color: #ff4500;">3</span> + <span style="color: #ff4500;">3</span><span style="color: black;">&#41;</span> &amp; -<span style="color: #ff4500;">4</span>
            padding <span style="color: #66cc66;">=</span> <span style="color: #ff4500;">0</span> <span style="color: #ff7700;font-weight:bold;">if</span> to_take % <span style="color: #ff4500;">8</span> <span style="color: #66cc66;">==</span> <span style="color: #ff4500;">0</span> <span style="color: #ff7700;font-weight:bold;">else</span> <span style="color: black;">&#40;</span>to_take % <span style="color: #ff4500;">8</span><span style="color: black;">&#41;</span> // <span style="color: #ff4500;">2</span>
            height<span style="color: #66cc66;">,</span> data <span style="color: #66cc66;">=</span> <span style="color: #008000;">self</span>.<span style="color: black;">height</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">data</span>
            scanlines <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span>b<span style="color: #483d8b;">'0'</span><span style="color: #66cc66;">,</span> data<span style="color: black;">&#91;</span>to_take*y:to_take*y+to_take-padding<span style="color: black;">&#93;</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">for</span> y <span style="color: #ff7700;font-weight:bold;">in</span> <span style="color: #008000;">range</span><span style="color: black;">&#40;</span>height<span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># les &quot;magic bytes&quot;, le marqueur du début de fichier qui indique</span>
            <span style="color: #808080; font-style: italic;"># que c'est un fichier png</span>
            magic <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;8B'</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">137</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">80</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">78</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">71</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">13</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">26</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">10</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Les metadata du fichiers : taille de l'image, une somme de</span>
            <span style="color: #808080; font-style: italic;"># controle, la profondeur de couleur, méthode de compression,</span>
            <span style="color: #808080; font-style: italic;"># le mode d'entrelacement, etc.</span>
            <span style="color: #808080; font-style: italic;"># Header: size, marker, data, CRC32</span>
            ihdr <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'IHDR'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: black;">&#93;</span>
            ihdr<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;2I5B'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">width</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">self</span>.<span style="color: black;">height</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">8</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">2</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">0</span><span style="color: black;">&#41;</span>
            ihdr<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">zlib</span>.<span style="color: black;">crc32</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>ihdr<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>:<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> &amp; <span style="color: #ff4500;">0xffffffff</span><span style="color: black;">&#41;</span>
            ihdr<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>ihdr<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># l'image en elle même avec un marker de départ, les pixels</span>
            <span style="color: #808080; font-style: italic;"># et une somme de controle</span>
            <span style="color: #808080; font-style: italic;"># Data: size, marker, data, CRC32</span>
            idat <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'IDAT'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: black;">&#93;</span>
            idat<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">zlib</span>.<span style="color: black;">compress</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>scanlines<span style="color: black;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #ff4500;">9</span><span style="color: black;">&#41;</span>
            idat<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">zlib</span>.<span style="color: black;">crc32</span><span style="color: black;">&#40;</span>b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>idat<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span>:<span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> &amp; <span style="color: #ff4500;">0xffffffff</span><span style="color: black;">&#41;</span>
            idat<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>idat<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># Les metadata à la fin du fichier qui sont vides.</span>
            <span style="color: #808080; font-style: italic;"># Footer: size, marker, None, CRC32</span>
            iend <span style="color: #66cc66;">=</span> <span style="color: black;">&#91;</span>b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">'IEND'</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: #66cc66;">,</span> b<span style="color: #483d8b;">''</span><span style="color: black;">&#93;</span>
            iend<span style="color: black;">&#91;</span><span style="color: #ff4500;">3</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #dc143c;">zlib</span>.<span style="color: black;">crc32</span><span style="color: black;">&#40;</span>iend<span style="color: black;">&#91;</span><span style="color: #ff4500;">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span> &amp; <span style="color: #ff4500;">0xffffffff</span><span style="color: black;">&#41;</span>
            iend<span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span> <span style="color: #66cc66;">=</span> pack<span style="color: black;">&#40;</span>b<span style="color: #483d8b;">'&gt;I'</span><span style="color: #66cc66;">,</span> <span style="color: #008000;">len</span><span style="color: black;">&#40;</span>iend<span style="color: black;">&#91;</span><span style="color: #ff4500;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;"># On écrit le fichier, et on retourne son nom</span>
            fileh.<span style="color: black;">write</span><span style="color: black;">&#40;</span>magic + b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>ihdr<span style="color: black;">&#41;</span> + b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>idat<span style="color: black;">&#41;</span> + b<span style="color: #483d8b;">''</span>.<span style="color: black;">join</span><span style="color: black;">&#40;</span>iend<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
            <span style="color: #ff7700;font-weight:bold;">return</span> output
        <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">None</span>
&nbsp;
<span style="color: #808080; font-style: italic;"># Un exemple d'usage avec l'habituel if __name__ pour éviter de</span>
<span style="color: #808080; font-style: italic;"># le lancer à l'import</span>
<span style="color: #ff7700;font-weight:bold;">if</span> __name__ <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'__main__'</span>:
&nbsp;
    systems <span style="color: #66cc66;">=</span> <span style="color: black;">&#123;</span>
        <span style="color: #483d8b;">'Darwin'</span> : MSSMac<span style="color: #66cc66;">,</span>
        <span style="color: #483d8b;">'Linux'</span>  : MSSLinux<span style="color: #66cc66;">,</span>
        <span style="color: #483d8b;">'Windows'</span>: MSSWindows
    <span style="color: black;">&#125;</span>
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        MSS <span style="color: #66cc66;">=</span> systems<span style="color: black;">&#91;</span>system<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">KeyError</span>:
        err <span style="color: #66cc66;">=</span> <span style="color: #483d8b;">'System &quot;{0}&quot; not implemented.'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>system<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">NotImplementedError</span><span style="color: black;">&#40;</span>err<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">try</span>:
        mss <span style="color: #66cc66;">=</span> MSS<span style="color: black;">&#40;</span>debug<span style="color: #66cc66;">=</span><span style="color: #008000;">False</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># One screen shot per monitor</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> filename <span style="color: #ff7700;font-weight:bold;">in</span> mss.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'File &quot;{0}&quot; created.'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>filename<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
&nbsp;
        <span style="color: #808080; font-style: italic;"># A shot to grab them all :)</span>
        <span style="color: #ff7700;font-weight:bold;">for</span> filename <span style="color: #ff7700;font-weight:bold;">in</span> mss.<span style="color: black;">save</span><span style="color: black;">&#40;</span>oneshot<span style="color: #66cc66;">=</span><span style="color: #008000;">True</span><span style="color: black;">&#41;</span>:
            <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'File &quot;{0}&quot; created.'</span>.<span style="color: black;">format</span><span style="color: black;">&#40;</span>filename<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>
    <span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">Exception</span> <span style="color: #ff7700;font-weight:bold;">as</span> ex:
        <span style="color: #ff7700;font-weight:bold;">print</span><span style="color: black;">&#40;</span>ex<span style="color: black;">&#41;</span>
        <span style="color: #ff7700;font-weight:bold;">raise</span></pre></td></tr></table></div>

]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/explication-de-code-python-mss/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2014/02/yu1p0xS.jpg" length="124166" type="image/jpg" />	</item>
		<item>
		<title>Ouvrir un fichier avec le bon programme en Python 16</title>
		<link>http://sametmax.com/ouvrir-un-fichier-avec-le-bon-programme-en-python/</link>
		<comments>http://sametmax.com/ouvrir-un-fichier-avec-le-bon-programme-en-python/#comments</comments>
		<pubDate>Thu, 17 Oct 2013 10:09:59 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[fichier]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[mac]]></category>
		<category><![CDATA[open]]></category>
		<category><![CDATA[os]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[windows]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7469</guid>
		<description><![CDATA[Les OS ont des réglages par défaut pour chaque type de fichier, et on peut demander "ouvrir le type de fichier par défaut". Par exemple, moi, si on je demande d'ouvrir un fichier vidéo, je m'attend à ce que VLC soit lancé.

Voilà comment faire ça en Python.]]></description>
				<content:encoded><![CDATA[<p>Votre logiciel doit permettre d&#8217;ouvrir un fichier avec un programme externe. Oui mais lequel ?</p>
<p>Les OS ont des réglages par défaut pour chaque type de fichier, et on peut demander &#8220;ouvrir le prog pour ce type de fichier par défaut&#8221;. Par exemple, moi, si je demande d&#8217;ouvrir un fichier vidéo, je m&#8217;attend à ce que VLC soit lancé.</p>
<p>Voilà comment faire ça en Python :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">subprocess</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">sys</span>
<span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">os</span>
&nbsp;
<span style="color: #ff7700;font-weight:bold;">def</span> run_file<span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
&nbsp;
    <span style="color: #808080; font-style: italic;"># Pas de EAFP cette fois puisqu'on est dans un process externe,</span>
    <span style="color: #808080; font-style: italic;"># on ne peut pas gérer l'exception aussi facilement, donc on fait</span>
    <span style="color: #808080; font-style: italic;"># des checks essentiels avant.</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Vérifier que le fichier existe</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">path</span>.<span style="color: black;">exists</span><span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">IOError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'No such file: %s'</span> % path<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># On a accès en lecture ?</span>
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">hasattr</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'access'</span><span style="color: black;">&#41;</span> <span style="color: #ff7700;font-weight:bold;">and</span> <span style="color: #ff7700;font-weight:bold;">not</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">access</span><span style="color: black;">&#40;</span>path<span style="color: #66cc66;">,</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">R_OK</span><span style="color: black;">&#41;</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">IOError</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'Cannot access file: %s'</span> % path<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Lancer le bon programme pour le bon OS :</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">if</span> <span style="color: #008000;">hasattr</span><span style="color: black;">&#40;</span><span style="color: #dc143c;">os</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'startfile'</span><span style="color: black;">&#41;</span>: <span style="color: #808080; font-style: italic;"># Windows</span>
        <span style="color: #808080; font-style: italic;"># Startfile est très limité sous Windows, on ne pourra pas savoir</span>
        <span style="color: #808080; font-style: italic;"># si il y a eu une erreu</span>
        proc <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">os</span>.<span style="color: black;">startfile</span><span style="color: black;">&#40;</span>path<span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #dc143c;">sys</span>.<span style="color: #dc143c;">platform</span>.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'linux'</span><span style="color: black;">&#41;</span>: <span style="color: #808080; font-style: italic;"># Linux:</span>
        proc <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">subprocess</span>.<span style="color: black;">Popen</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'xdg-open'</span><span style="color: #66cc66;">,</span> path<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> 
                                 <span style="color: #808080; font-style: italic;"># on capture stdin et out pour rendre le </span>
                                 <span style="color: #808080; font-style: italic;"># tout non bloquant</span>
                                 stdout<span style="color: #66cc66;">=</span><span style="color: #dc143c;">subprocess</span>.<span style="color: black;">PIPE</span><span style="color: #66cc66;">,</span> stderr<span style="color: #66cc66;">=</span><span style="color: #dc143c;">subprocess</span>.<span style="color: black;">PIPE</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">elif</span> <span style="color: #dc143c;">sys</span>.<span style="color: #dc143c;">platform</span> <span style="color: #66cc66;">==</span> <span style="color: #483d8b;">'darwin'</span>: <span style="color: #808080; font-style: italic;"># Mac:</span>
        proc <span style="color: #66cc66;">=</span> <span style="color: #dc143c;">subprocess</span>.<span style="color: black;">Popen</span><span style="color: black;">&#40;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'open'</span><span style="color: #66cc66;">,</span> <span style="color: #483d8b;">'--'</span><span style="color: #66cc66;">,</span> path<span style="color: black;">&#93;</span><span style="color: #66cc66;">,</span> 
                                stdout<span style="color: #66cc66;">=</span><span style="color: #dc143c;">subprocess</span>.<span style="color: black;">PIPE</span><span style="color: #66cc66;">,</span> stderr<span style="color: #66cc66;">=</span><span style="color: #dc143c;">subprocess</span>.<span style="color: black;">PIPE</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #ff7700;font-weight:bold;">else</span>:
        <span style="color: #ff7700;font-weight:bold;">raise</span> <span style="color: #008000;">NotImplementedError</span><span style="color: black;">&#40;</span>
            <span style="color: #483d8b;">&quot;Your `%s` isn't a supported operatin system`.&quot;</span> % <span style="color: #dc143c;">sys</span>.<span style="color: #dc143c;">platform</span><span style="color: black;">&#41;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;"># Proc sera toujours None sous Windows. Sous les autres OS, il permet de</span>
    <span style="color: #808080; font-style: italic;"># récupérer le status code du programme, and lire / ecrire sur stdin et out</span>
    <span style="color: #ff7700;font-weight:bold;">return</span> proc</pre></td></tr></table></div>

<p>C&#8217;était le petit snippet sympas du jour !</p>
<p>P.S : si quelqu&#8217;un utilise <del>BDSM</del> BSD ou Solaris, je veux bien qu&#8217;il complète le snippet.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/ouvrir-un-fichier-avec-le-bon-programme-en-python/feed/</wfw:commentRss>
		<slash:comments>16</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/10/qzb7emC.jpg" length="54438" type="image/jpg" />	</item>
		<item>
		<title>Tiens, je suis toujours sur OSX 81</title>
		<link>http://sametmax.com/tiens-je-suis-toujours-sur-osx/</link>
		<comments>http://sametmax.com/tiens-je-suis-toujours-sur-osx/#comments</comments>
		<pubDate>Wed, 19 Jun 2013 11:23:42 +0000</pubDate>
		<dc:creator><![CDATA[coyote]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[mac]]></category>
		<category><![CDATA[mac os]]></category>
		<category><![CDATA[ubuntu]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6419</guid>
		<description><![CDATA[Soudain, je sais plus exactement vers quelle version, je crois que c'était la 10.10, Ubuntu a commencé à devenir de plus en plus pénible et les nouvelles versions n'ont fait qu'accroitre la frustration.]]></description>
				<content:encoded><![CDATA[<p style="text-align: center;"><em><small>Ceci est un post invité de <a href="http://sametmax.com/author/coyote/">coyote</a> posté sous licence <a href="http://creativecommons.org/licenses/by/3.0/">creative common 3.0 unported</a>.</small></em></p>
<p><strong>Attention</strong>: ce qui suit est un billet d&#8217;humeur personnel. Prenez le comme tel…</p>
<p>Je suis un <em>linuxien</em>. Pas un activiste, mais tout de même un fervent défenseur du logiciel libre et de Linux (oui pour moi écrire <em>GNU/Linux</em> partout c&#8217;est pédant et inutile – et ça te fait passer pour un gros nazi.). J&#8217;ai même créé une association de défense du libre, un <acronym title="Linux User Group">LUG</acronym> et fait <em>switcher</em> de très nombreuses personnes.</p>
<h2>Mais alors, <strong>bordel, que fais-je sur<sup>1</sup> OSX ?</strong></h2>
<p><sup>1</sup> Si quelqu&#8217;un a une règle pour décrire rapidement que l&#8217;on utilise un OS, en lieu et place de “<em>sur Ubuntu</em>”, “<em>sous Windows</em>’”, etc ; qu&#8217;il la balance car c&#8217;est juste insupportable.</p>
<p>Tout à commencé sans doute quand j&#8217;ai découvert Sublime Text (merci Sam!). J&#8217;ai alors rompu mon workflow entièrement libre pour y intégrer un outil proprio, mais fantastique et dont je me suis précipité pour payer la licence afin de remercier le développeur pour cette bouffée d&#8217;oxygène.</p>
<p>J&#8217;utilise régulièrement des Mac comme machine depuis plusieurs années (2003?) et ce pour plusieurs raisons:</p>
<ul>
<li>C&#8217;est propre. Pas de sticker dégueulasse, de look plastique ou autre.</li>
<li>C&#8217;est une grande marque avec peu de modèles: l&#8217;assurance d&#8217;avoir un support pour Linux relativement rapidement.</li>
<li>C&#8217;est de bonne qualité (oui il y a toujours des exceptions), ça dure longtemps et ça se revend pas trop mal.</li>
<li>Le connecteur d&#8217;alim aimanté ; tous ceux qui ont déjà cassé un laptop à cause de ça comprendront…</li>
<li>Je fais un peu de dev multiplateforme (libre!) et il faut toujours tester/ajuster sur OSX.</li>
</ul>
<p>Me voilà donc avec une machine Mac dont je suis satisfait, faisant tourner un Ubuntu que j&#8217;adore avec un dual boot que j&#8217;utilise dans les aéroports ou autre car la conso batterie est <strong>incomparable</strong> entre Ubuntu et OSX.</p>
<p>Linux a toujours eu des petits problèmes, la batterie dont je parlais, le WiFi, le suspend/hibernation, etc. Rien d&#8217;insurmontable pour quelqu&#8217;un de convaincu.</p>
<h2>L&#8217;aigle noir</h2>
<p>Soudain, je sais plus exactement vers quelle version, je crois que c&#8217;était la 10.10, Ubuntu a commencé à devenir de plus en plus pénible et les nouvelles versions n&#8217;ont fait qu&#8217;accroitre la frustration.</p>
<p>Le passage à Unity a été difficile, et le fait de tester d&#8217;autres alternatives (XFCE, Xmonad) permet de se rendre compte à quel point Ubuntu est <em>intégré</em>: beaucoup de composants ne sont plus vraiment interchangeable ou alors au prix de gros efforts de configurations voir de hacks. En bref, <strong>Ubuntu, c&#8217;est bien si tu y touches pas trop</strong>.</p>
<p>Au fil des versions, des nouveaux problèmes, des fonctionnalités perdues, toute tentative montrant à quel point Ubuntu s&#8217;écarte du Linux modulaire, j&#8217;ai décidé de franchir le Rubicon et de tester d&#8217;autres distros.</p>
<p>Pour faire (très) court :</p>
<ul>
<li>Toutes les non-debian ne m&#8217;ont pas plu: la gestion des paquets est contre-productive pour moi qui ait des années d&#8217;apt dans les dents. Surtout, c&#8217;est <strong>lent comme la mort</strong>. Incroyablement lent en 2013 ; WTF?</li>
<li>Les Debian-Ubuntu-based: la plupart sont des customisations d&#8217;Ubuntu avec des paquets différents, des thèmes et des outils. J&#8217;ai pas vu d&#8217;avantages vraiment et toutes ont des petits désagréments supplémentaires, sans compter que les problèmes spécifiques sont dur à résoudre car ils ont peu d&#8217;utilisateurs.</li>
<li>Debian ; j&#8217;ai beaucoup aimé car c&#8217;est très simple, la modularité est là, la vitesse aussi ; c&#8217;est bien intégré. Malheureusement, la gestion non souple des paquets (soit tout est vieux, soit tout est jeune) couplé avec l&#8217;absence de PPA (<strong>les PPA, c&#8217;est génial!</strong>) font que j&#8217;ai renoncé.</li>
</ul>
<h2>Archlinux</h2>
<p>Je suis donc resté sur Archlinux. J&#8217;avais utilisé un peu par le passé et ça correspondait bien à ce que je voulais actuellement: quelque chose de propre, documenté où je savais qu&#8217;en cas de problème, je pourrais l&#8217;identifier facilement.</p>
<p>Archlinux m&#8217;a pris du temps pour le configurer. C&#8217;est sans doute ce qui m&#8217;a le plus dérangé car <strong>j&#8217;utilise mon laptop pour travailler</strong>, pas pour geeker. Une journée de perdue à configurer la machine, c&#8217;est une journée de travail en moins avec des conséquences en sousous.</p>
<p>Mais j&#8217;étais satisfait d&#8217;Archlinux, c&#8217;était effectivement beaucoup plus simple et clair qu&#8217;Ubuntu. J&#8217;ai pu faire fonctionner des petites choses qui marchaient pas avec Ubuntu ; j&#8217;avais un Gnome à jour, etc.</p>
<p>Mais, car il y a toujours un mais ; Archlinux a aussi ses problèmes: il <strong>veut</strong> que vous soyez à jour, et vous avez pas intérêt à le contrarier ; mais en même temps, il faut vérifier ce qu&#8217;il fait donc re-perte de temps.</p>
<p>Au fil du temps, les problèmes des logiciels récents se faisaient plus frustrants ; une version qui marche ; une qui marche pas, etc.</p>
<p>Quand je me suis rendu compte que je devais redémarrer ma machine plus d&#8217;une fois par semaine, et que je perdais vraiment du temps avec des bêtises, je me suis dit “<em>oh et puis merde, je vais mettre OSX!</em>” (oui je reste relativement poli dans ma tête).</p>
<h2>Le trou noir</h2>
<p>J&#8217;ai formatté ma machine sur un coup de tête, un week-end, pour voir si vraiment Linux devenait de la fiente d&#8217;âne ou si c&#8217;était partout pareil. Je me suis dis, ce sera l&#8217;occasion de voir à quoi ressemble la concurrence, de voir comment se comporte cette machine dans son environnement naturel (genre voir ce que ça fait d&#8217;utiliser un SSD qui a couté la peau du Q). Je voulais tester ça une semaine, deux tout au plus.</p>
<p>C&#8217;était il y a des mois déjà. Je sais plus trop quand. Janvier ? Février ? Je ne m&#8217;en souviens pas car <strong>je ne pense plus à ma machine</strong>. Je l&#8217;oublie complètement.</p>
<p>Bien sûr, au début, je raillais ce système et ses perversions (installer GCC nécessite de passer par un Store à la con), et puis, passé les deux premiers jours de <em>setup</em>, je l&#8217;ai oublié. Le matin, j&#8217;arrive au boulot, la machine est là, allumée, prête, rapide, disponible. Je travaille, et je lui <em>cloue le bec</em> en partant, chose qui ne marchait pas avant.</p>
<p>Je peux me promener avec sans craindre pour la batterie, je peux utiliser le Wifi à tout moment (pas besoin de patcher le kernel dans un hôtel), je peux faire de la visio-conf sans jongler avec 2 outils PulseAudio, le trackpad marche à merveille, le tout démarre en moins de 10s, j&#8217;ai mon Sublime Text, mon terminal, mon ipython et toute sa clique, bref, c&#8217;est le bonheur.</p>
<p>Je ne sais pas quand je vais retourner sous Linux ; la simple idée de me retaper le setup à l&#8217;envers alors que je suis si productif maintenant me donne la nausée. Je n&#8217;ai même pas été tenté à la sortie du 13.04. Tout juste ais-je pris le temps de lancer le Live-CD dans VirtualBox.</p>
<p>Bien sûr, tout n&#8217;est pas rose, je connais bien les arcanes de Linux, mais pas celles d&#8217;OSX ; dès qu&#8217;il y a une dépendances bizarre dans un projet (genre opencv), je prends peur car tout n&#8217;est pas aussi bien packagé, ou aussi facilement compilable, etc mais finalement, ça n&#8217;arrive pas très souvent.</p>
<p>Vous m&#8217;avez lu jusqu&#8217;ici, bravo, je n&#8217;ai pas écrit tout ça pour vous convaincre de quoi que ce soit ou pour me justifier. Je suis toujours autant dérangé par Apple, je ne me sens pas à l&#8217;aise en utilisant OSX, mais je peux enfin utiliser ma machine comme l&#8217;outil de dev qu&#8217;il devrait être et rien d&#8217;autre ; c&#8217;est un soulagement très grand.</p>
<p>J&#8217;espère retrouver dans les commentaires de ce billet vos frustrations concernant Linux et pourquoi pas ce que vous faites pour y remédier (Punching Ball?).</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/tiens-je-suis-toujours-sur-osx/feed/</wfw:commentRss>
		<slash:comments>81</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2013/06/35aTn.jpg" length="76539" type="image/jpg" />	</item>
		<item>
		<title>Synchroniser son serveur avec ntp sous Linux 4</title>
		<link>http://sametmax.com/synchroniser-son-serveur-avec-ntp-sous-linux/</link>
		<comments>http://sametmax.com/synchroniser-son-serveur-avec-ntp-sous-linux/#comments</comments>
		<pubDate>Wed, 15 May 2013 07:32:53 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[ntp]]></category>
		<category><![CDATA[serveur]]></category>
		<category><![CDATA[synchroniser]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=1086</guid>
		<description><![CDATA[Synchroniser son serveur avec l'heure sub-atomique de Sirus B en quelques clics...]]></description>
				<content:encoded><![CDATA[<p>NTP (Network Time Protocol) est un protocole utilisé pour synchroniser l&#8217;heure de votre système en utilisant un serveur en ligne. Cet article explique comment l&#8217;installer et le configurer sur un système d&#8217;exploitation Linux.</p>
<p><strong>1. Installation</strong></p>
<p>Pour installer le service ntp, ouvrez un terminal en root.</p>
<p><b>Sous Ubuntu:</b></p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">sudo</span> <span style="color: #c20cb9; font-weight: bold;">apt-get install</span> ntp</pre></td></tr></table></div>

<p><b><br />
2. Utilisation<br />
</b></p>
<p>La configuration de ntp se trouve généralement dans le fichier /etc/ntp.conf. On peut y ajouter de nouveaux serveurs de temps, en ajoutant une ligne similaire à celle-ci par exemple :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">server <span style="color: #000000;">0</span>.fedora.pool.ntp.org dynamic</pre></td></tr></table></div>

<p>Démarrez ensuite le service avec cette commande afin de synchroniser la date et l&#8217;heure (Attention, il faut plusieurs minutes avant que l&#8217;heure soit synchronisée) :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">/</span>etc<span style="color: #000000; font-weight: bold;">/</span>init.d<span style="color: #000000; font-weight: bold;">/</span>ntpd start</pre></td></tr></table></div>

<p>On pourra ensuite vérifier que l&#8217;heure est correcte avec la commande &#8220;date&#8221;:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>sm<span style="color: #000000; font-weight: bold;">@</span>web1 ~<span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #666666; font-style: italic;"># date</span>
Wed May <span style="color: #000000;">15</span> 07:<span style="color: #000000;">21</span>:<span style="color: #000000;">15</span> UTC <span style="color: #000000;">2013</span>
<span style="color: #7a0874; font-weight: bold;">&#91;</span>sm<span style="color: #000000; font-weight: bold;">@</span>web1 ~<span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #666666; font-style: italic;">#</span></pre></td></tr></table></div>

<p>Note : en cas de problème, on pourra vérifier le bon fonctionnement avec la commande ntpstat qui donnera des informations sur le statut du service ntp :</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #7a0874; font-weight: bold;">&#91;</span>sm<span style="color: #000000; font-weight: bold;">@</span>web1 ~<span style="color: #7a0874; font-weight: bold;">&#93;</span><span style="color: #666666; font-style: italic;"># ntpstat</span>
synchronised to NTP server <span style="color: #7a0874; font-weight: bold;">&#40;</span>213.161.194.93<span style="color: #7a0874; font-weight: bold;">&#41;</span> at stratum <span style="color: #000000;">4</span>
<span style="color: #000000; font-weight: bold;">time</span> correct to within <span style="color: #000000;">562</span> ms
polling server every <span style="color: #000000;">64</span> s</pre></td></tr></table></div>

<p><b>A quoi ça sert ?</b></p>
<p>Dans notre cas nous avons des sites qui hébergent du contenu avec des urls qui expirent au bout d&#8217;un certainstemps.<br />
La création de ces urls à durée de vie comptée est faite depuis le serveur web, le contenu se trouvant sur d&#8217;autres serveurs.<br />
ntp dans ce cas nous assure que tous les serveurs seront calés sur la même heure, ce qui évite de générer des urls déjà expirées si un des serveurs de contenu n&#8217;était pas à l&#8217;heure.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/synchroniser-son-serveur-avec-ntp-sous-linux/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/07/screenshot_86.jpg" length="53235" type="image/jpg" />	</item>
		<item>
		<title>Les usages légaux de BitTorrent 11</title>
		<link>http://sametmax.com/les-usages-legaux-de-bittorrent/</link>
		<comments>http://sametmax.com/les-usages-legaux-de-bittorrent/#comments</comments>
		<pubDate>Sat, 15 Sep 2012 15:08:18 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[bittorent]]></category>
		<category><![CDATA[blizzard]]></category>
		<category><![CDATA[deploiement]]></category>
		<category><![CDATA[facebook]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[p2p]]></category>
		<category><![CDATA[streaming]]></category>
		<category><![CDATA[twitter]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2094</guid>
		<description><![CDATA[BitTorrent est diabolisé, mais c'est comme la télévision: ce n'est pas parce que la majorité des gens en font un mauvais usage qu'il faut considérer que c'est une technologie satanique.]]></description>
				<content:encoded><![CDATA[<p><a href="https://fr.wikipedia.org/wiki/BitTorrent_%28protocole%29">BitTorrent</a> est diabolisé, mais c&#8217;est comme la télévision: ce n&#8217;est pas parce que la majorité des gens en font un mauvais usage qu&#8217;il faut considérer que c&#8217;est une technologie satanique.</p>
<h2>Déploiement de code</h2>
<p>BitTorrent à cela de merveilleux que plus il y a de personnes qui téléchargent, plus le téléchargement est rapide. Pour cette raison, les grandes entreprises l&#8217;utilisent pour déployer leur code en productions sur leurs centaines de serveur, avec des <a href="http://vimeo.com/11280885">gains de vitesse allant jusqu&#8217;à 7500 %</a>.</p>
<p>Twitter et <a href="http://torrentfreak.com/facebook-uses-bittorrent-and-they-love-it-100625/">Facebook</a> sont connus pour utiliser le protocole p2p pour économiser exactement ça.</p>
<h2>Distribution de patch et vente de jeux</h2>
<p>On pense toujours que le peer to peer ce n&#8217;est pas pour le kikoo lol moyen, que c&#8217;est compliqué. Mais en fait énormément de Kevin de base utilisent BitTorrent sans le savoir.</p>
<p>La raison ?</p>
<div id="attachment_2112" style="width: 366px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2012/09/patch3.jpg" class="grouped_elements" rel="tc-fancybox-group2094"><img class=" wp-image-2112 " title="Vous jouez à Wow, SC2 ou Diablo 3 ? Vous utilisez BitTorrent !" src="http://sametmax.com/wp-content/uploads/2012/09/patch3.jpg" alt="Capture d'écran du logiciel de mise à jour des jeux Blizzard" width="356" height="316" /></a><p class="wp-caption-text">Vous jouez à Wow, SC2 ou Diablo 3 ? Vous utilisez BitTorrent !</p></div>
<p>Blizzard utilise en effet BitTorrent dans son fameux logiciel &#8220;Blizzard downloader&#8221; pour distribuer les installeurs des jeux vendus sur Battle.net, mais également toutes les mises à jour des dit jeux.</p>
<p>Quand on a des millions de joueurs qui sont du coup autant de serveurs, on économise un MAX de pognon. On parle de millions d&#8217;euros là.</p>
<h2>Distribution d&#8217;iso</h2>
<p>Quelqu&#8217;un qui surf sur Internet (<a href="http://en.wikipedia.org/wiki/Usage_share_of_operating_systems#Servers">60% des serveurs Web dans le monde</a>), utilise un téléphone Android ou regarde une vidéo sur sa Freebox utilise Linux. Or l&#8217;acquisition d&#8217;une ISO d&#8217;installation Linux se fait massivement à travers BitTorrent, pour justement éviter de surcharger les éditeurs de distro qui ont un budget limité. Votre serviteur tape d&#8217;ailleurs cet article sur une Ubuntu installé depuis une ISO téléchargée via BitTorrent.</p>
<p>D&#8217;une manière générale, si on a un gros fichier à partager sur un blog, le mettre à disposition via BitTorrent est ce qu&#8217;il y a de plus pratique, ça évite de tuer son hébergement. Pour cette raison, <a href="http://noisemore.wordpress.com/2006/03/14/amazon-s3-has-bittorrent-support/">Amazon S3 le supporte par défaut</a>.</p>
<h2>Potentiel</h2>
<p>Parce que des gens stressés par la mutation des mœurs ne voient pas plus loin que le bout de leur narines, et parce que &#8220;BitTorrent, c&#8217;est surtout utilisé pour pirater, il faut pas déconner&#8221;, cette technologie est largement sous exploitée. On pourrait faire la mise à jour de tous les logiciels avec, même la mise à jour des OS, et carrément l&#8217;intégrer dans les gestionnaires de paquets. On pourrait faire du streaming avec: chaque visionneur repartageant des paquets, et allégeant la charge des fournisseurs de VOD.</p>
<p>Si l&#8217;usage de BitTorrent se généralise, ce sont des économies à l&#8217;échelle du monde qui seront réalisées, mais aussi l&#8217;opportunité pour plein de &#8220;petits&#8221; de mettre à disposition du gros contenu pour le grand public. Ce serait fabuleux que tous les navigateurs intègrent le téléchargement BitTorrent par défaut, comme le fait <a href="http://help.opera.com/Windows/9.00/en/bittorrent.html">Opéra</a> (qui est d&#8217;ailleurs aussi <a href="http://www.opera.com/download/torrents/">téléchargeable</a> en torrent). Parce que pour le moment, allez proposer à mamie de télécharger un truc avec BitTorrent&#8230; J&#8217;ai expliqué à mon père il y a quelques semaines, lui qui pourtant sait ce que c&#8217;est qu&#8217;un cable SCSI et qui a été le premier à utiliser CloneCD en son temps, il a eu du mal.</p>
<p>Pour le moment, les ports sont souvent bloqués, le protocole est souvent bridé, les applications <a href="http://torrentfreak.com/apple-sorry-bittorrent-apps-were-approved-by-mistake-120911/">censurées</a> sur les appstores, et tout ce potentiel est perdu.</p>
<p>Chers éditeurs de contenu, même dans le cas improbable ou vous gagniez la bataille de la maîtrise du Net, empêchant les méchants pirates de vous voler de quoi vous acheter votre prochain coupé sport, j&#8217;ai toujours un disque dur externe et des amis. Qui en ont aussi.</p>
<p>Donc puisque vous ne pouvez pas arrêter le piratage sans transformer le pays en dictature stalinienne, ayez au moins la décence de laisser tranquille des technologies brillantes et extraordinairement utiles pour tous. C&#8217;est peut être un détail pour vous, mais pour nous ça veut dire beaucoup.</p>
<p>&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/les-usages-legaux-de-bittorrent/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/Kinder-interdit-Armes-autorisées-640x303.jpg" length="36217" type="image/jpg" />	</item>
		<item>
		<title>Liste des partitions, de leur type, de la place restante sous Linux &#8211; df / du 14</title>
		<link>http://sametmax.com/liste-des-partitions-de-leur-type-de-la-place-restante-sous-linux-df-du/</link>
		<comments>http://sametmax.com/liste-des-partitions-de-leur-type-de-la-place-restante-sous-linux-df-du/#comments</comments>
		<pubDate>Mon, 10 Sep 2012 01:36:48 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[bash]]></category>
		<category><![CDATA[df]]></category>
		<category><![CDATA[disque]]></category>
		<category><![CDATA[du]]></category>
		<category><![CDATA[espace]]></category>
		<category><![CDATA[linux]]></category>
		<category><![CDATA[partition]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2049</guid>
		<description><![CDATA[Quelques commandes sympa sous Linux pour connaître les ressources disque de son serveur.]]></description>
				<content:encoded><![CDATA[<p>Quelques commandes sympa sous Linux pour connaître les ressources disque de son serveur.</p>
<p><strong>la commande df:</strong><br />
Retourne l&#8217;espace disque utilisé par chaque partition montée sur votre machine.</p>
<p>-h Affiche les résultats sous forme humainement lisible :)<br />
-T indique le type de système de fichiers utilisé</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">df</span> <span style="color: #660033;">-hT</span>
Sys. fich.    Type  Taille  Uti. Disp. Uti<span style="color: #000000; font-weight: bold;">%</span> Monté sur
<span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>sda2      xfs     20G  <span style="color: #000000;">2</span>,9G   17G  <span style="color: #000000;">15</span><span style="color: #000000; font-weight: bold;">%</span> <span style="color: #000000; font-weight: bold;">/</span>
tmpfs        tmpfs    <span style="color: #000000;">3</span>,9G     <span style="color: #000000;">0</span>  <span style="color: #000000;">3</span>,9G   <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">%</span> <span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>shm
<span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>sda1      xfs    192M   28M  164M  <span style="color: #000000;">15</span><span style="color: #000000; font-weight: bold;">%</span> <span style="color: #000000; font-weight: bold;">/</span>boot
<span style="color: #000000; font-weight: bold;">/</span>dev<span style="color: #000000; font-weight: bold;">/</span>sda4      xfs    <span style="color: #000000;">1</span>,8T  220G  <span style="color: #000000;">1</span>,6T  <span style="color: #000000;">12</span><span style="color: #000000; font-weight: bold;">%</span> <span style="color: #000000; font-weight: bold;">/</span>data</pre></td></tr></table></div>

<p><strong>la commande du:</strong><br />
Retourne l&#8217;espace disque utilisé par un répertoire</p>
<p>-h Affiche les résultats sous forme humainement lisible :)<br />
-s affiche la somme des fichiers du répertoire</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #c20cb9; font-weight: bold;">du</span> <span style="color: #660033;">-hs</span> <span style="color: #000000; font-weight: bold;">/</span>boot<span style="color: #000000; font-weight: bold;">/</span>
18M	<span style="color: #000000; font-weight: bold;">/</span>boot<span style="color: #000000; font-weight: bold;">/</span></pre></td></tr></table></div>

<p>Et si vous voulez trouver ce qui prend toute cette place, c&#8217;est <a href="http://sametmax.com/trouver-ce-qui-prend-de-la-place-en-ligne-de-commande/">par ici</a>.</p>
<p><strong>Edit:</strong><br />
Pour le côté prog on peu utiliser <a href="http://code.google.com/p/psutil/">psutil</a> en python qui permet tout un tas d&#8217;acceès aux infos de la machine.<br />
Merci François</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/liste-des-partitions-de-leur-type-de-la-place-restante-sous-linux-df-du/feed/</wfw:commentRss>
		<slash:comments>14</slash:comments>
	<enclosure url="http://sametmax.com/wp-content/uploads/2012/09/disque-vinyl.jpeg" length="61713" type="image/jpg" />	</item>
	</channel>
</rss>
